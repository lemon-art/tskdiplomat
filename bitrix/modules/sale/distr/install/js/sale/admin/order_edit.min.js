BX.namespace("BX.Sale.Admin.OrderEditPage");BX.Sale.Admin.OrderEditPage={formId:"",fieldsUpdaters:{},fieldsUpdatersContexts:{},statusesNames:{},orderId:0,languageId:"",siteId:"",currency:"",currencyLang:"",form:null,adminTabControlId:"",discountRefreshTimeoutId:0,getForm:function(){if(!BX.Sale.Admin.OrderEditPage.form)BX.Sale.Admin.OrderEditPage.form=BX(BX.Sale.Admin.OrderEditPage.formId);return BX.Sale.Admin.OrderEditPage.form},toggleFix:function(e,t){var a=BX(t),r=BX(e);if(!a||!r)return;var i=!BX.hasClass(a,"adm-detail-tabs-block-pin");if(i){BX.addClass(a,"adm-detail-tabs-block-pin");r.title=BX.message("SALE_ORDEREDIT_FIX");BX.UnFix(a)}else{BX.removeClass(a,"adm-detail-tabs-block-pin");r.title=BX.message("SALE_ORDEREDIT_UNFIX");BX.Fix(a,{type:"top"});window[this.adminTabControlId].ToggleFix("top",false)}i=!i;BX.userOptions.save("sale_admin","sale_order_edit","fix_"+t,i?"Y":"N")},disableSavingButtons:function(e){var t,a,r=["apply","save"];for(t in r){a=BX.findChild(document,{attr:{name:r[t]}},true);if(a)a.disabled=e}},showDialog:function(e,t){alert(e)},onSaveStatusButton:function(e,t){BX.Sale.Admin.OrderAjaxer.sendRequest(this.ajaxRequests.saveStatus(e,t))},onCancelStatusButton:function(e,t){this.toggleCancelDialog();BX.Sale.Admin.OrderAjaxer.sendRequest(this.ajaxRequests.cancelOrder(e,t,BX("FORM_REASON_CANCELED").value))},getElementValue:function(e){var t=BX(e);if(t&&typeof t.value!="undefined")return t.value;return""},getAllFormData:function(){var e=this.getForm();if(!e)return{};var t=BX.ajax.prepareForm(e);return!!t&&t.data?t.data:{}},unRegisterFieldUpdater:function(e,t){if(!this.fieldsUpdaters[e])return;for(var a=this.fieldsUpdaters[e].length-1;a>=0;a--)if(this.fieldsUpdaters[e][a]==t)delete this.fieldsUpdaters[e][a]},unRegisterProductFieldsUpdaters:function(e){for(var t in this.fieldsUpdaters)if(t.indexOf("PRODUCT["+e+"]")!=-1)delete this.fieldsUpdaters[t]},unRegisterFieldsUpdaters:function(e){for(var t in e)if(this.fieldsUpdaters[e[t]])delete this.fieldsUpdaters[e[t]]},registerFieldsUpdaters:function(e){for(var t in e){if(typeof this.fieldsUpdaters[t]=="undefined")this.fieldsUpdaters[t]=[];this.fieldsUpdaters[t].push(e[t])}},callFieldsUpdaters:function(e){var t=["DISCOUNTS_LIST","DELIVERY_PRICE"],a={};for(var r=0,i=t.length-1;r<=i;r++){var d=t[r];if(typeof e[d]!=="undefined")this.callConcreteFieldUpdater(d,e[d]);a[d]=true}for(r in e){if(a[r])continue;this.callConcreteFieldUpdater(r,e[r])}},callConcreteFieldUpdater:function(e,t){var a=null,r=null;for(var i in this.fieldsUpdaters[e]){var d=this.fieldsUpdaters[e][i];if(d.context&&d.callback){a=d.context;r=d.callback}else{a=null;r=this.fieldsUpdaters[e][i]}if(r&&typeof r=="function")r.call(a,t)}},currencyFormat:function(e,t){if(BX.Currency&&BX.Currency.currencyFormat){e=BX.Currency.currencyFormat(e,this.currency,t?false:true)}return e},restoreFormData:function(e){var t=this.getForm();if(!t){BX.debug("BX.Sale.Admin.OrderEditPage:restoreFormData() can't find form");return false}for(var a in e)if(typeof t.elements[a]!="undefined")t.elements[a].value=e[a];return true},createFormBlocker:function(){var e=document.documentElement.scrollHeight,t=document.documentElement.clientHeight,a=Math.max(e,t);return BX.create("div",{props:{className:"bx-core-dialog-overlay",id:"sale-adm-order-form-blocker"},style:{zIndex:"10001",width:"100%",height:a+"px",backgroundColor:"rgba(57,60,67,0.1)"},children:[BX.create("span",{style:{zIndex:"10002",top:"5%",left:"85%",position:"fixed",background:'url("/bitrix/panel/main/images/submenu-bg.png") repeat 0 0',padding:"15px",borderRadius:"5px",fontSize:"14px",border:"4px solid rgb(230, 230, 230)"},html:BX.message("SALE_ORDEREDIT_REFRESHING_DATA")})]})},blockForm:function(){document.body.appendChild(this.createFormBlocker())},unBlockForm:function(){var e=BX("sale-adm-order-form-blocker");if(e)e.parentNode.removeChild(e)},toggleCancelDialog:function(){var e=BX("sale-adm-status-cancel-dialog");if(e)BX.toggleClass(e,"active")},setStatus:function(e){BX("STATUS_ID").value=e},changeCancelBlock:function(e,t){var a=BX("sale-adm-status-cancel-blocktext"),r=BX("FORM_REASON_CANCELED"),i=BX("sale-adm-status-cancel-dialog-btn"),d="";if(t.CANCELED=="Y"){d='<div class="adm-s-select-popup-element-selected-bad">'+"<span>"+BX.message("SALE_ORDER_STATUS_CANCELED")+"</span>"+t.DATE_CANCELED+'<a href="/bitrix/admin/user_edit.php?lang='+BX.Sale.Admin.OrderEditPage.languageId+"&ID="+t.EMP_CANCELED_ID+'">'+BX.util.htmlspecialchars(t.EMP_CANCELED_NAME)+"</a>"+"</div>";a.style.textAlign="start";r.disabled=true;i.innerHTML=BX.message("SALE_ORDER_STATUS_CANCEL_CANCEL");i.onclick=function(){BX.Sale.Admin.OrderEditPage.onCancelStatusButton(e,"Y")}}else{d='<a href="javascript:void(0);" onclick="BX.Sale.Admin.OrderEditPage.toggleCancelDialog();">'+BX.message("SALE_ORDER_STATUS_CANCELING")+"</a>";a.style.textAlign="center";r.disabled=false;i.innerHTML=BX.message("SALE_ORDER_STATUS_CANCEL");i.onclick=function(){BX.Sale.Admin.OrderEditPage.onCancelStatusButton(e,"N")}}a.innerHTML=d},onRefreshOrderDataAndSave:function(){BX.Sale.Admin.OrderEditPage.blockForm();var e=this.getForm();e.appendChild(BX.create("input",{props:{name:"refresh_data_and_save",type:"hidden",value:"Y"}}));e.submit()},onOrderCopy:function(e){BX.Sale.Admin.OrderEditPage.blockForm();var t=this.getForm();t.action=e;t.submit()},createDiscountsNode:function(e,t,a,r,i){var d=null;if(a&&r&&r.DISCOUNT_LIST){d=BX.create("table");for(var n=0,s=a.length;n<s;n++){if(!a[n])continue;var l=a[n].DISCOUNT_ID;if(r.DISCOUNT_LIST[l]){this.addDiscountItemRow(e,t,a[n],r.DISCOUNT_LIST[l],d,i)}}}else{d=BX.create("span",{html:"&nbsp;"})}return BX.create("div",{children:[d]})},addDiscountItemRow:function(e,t,a,r,i,d){var n=i.insertRow(-1),s={"data-discount-id":r.DISCOUNT_ID};if(t=="DISCOUNT_LIST")s["data-discount"]="Y";var l="DISCOUNTS["+t+"]"+(e!=""?"["+e+"]":"")+"["+r.DISCOUNT_ID+"]",o=BX.create("input",{props:{type:"checkbox",name:l,checked:a.APPLY=="Y",value:"Y",disabled:d=="VIEW"},attrs:s});n.appendChild(BX.create("td",{children:[BX.create("input",{props:{type:"hidden",name:l,value:"N"}}),o]}));if(d=="EDIT"){BX.bind(o,"click",function(e){BX.Sale.Admin.OrderEditPage.setDiscountCheckbox(e);BX.Sale.Admin.OrderEditPage.refreshDiscounts()})}var c="";if(typeof a.DESCR=="object"){if(a.DESCR){for(var u in a.DESCR)c+=a.DESCR[u]}else{c=BX.message("SALE_ORDEREDIT_DISCOUNT_UNKNOWN")+" %"}}else{c=a.DESCR}n.appendChild(BX.create("td",{html:"<strong>"+c+"</strong>"}));if(r.EDIT_PAGE_URL){n.appendChild(BX.create("td",{children:[BX.create("a",{props:{href:r.EDIT_PAGE_URL,className:"adm-s-detail-content-sale-link"},html:r.NAME})]}))}else{n.appendChild(BX.create("td",{children:[BX.create("span",{html:r.NAME})]}))}return n},setDiscountCheckbox:function(e){var t=e.target,a;if(!!t&&t.hasAttribute("data-discount")&&t.hasAttribute("data-discount-id")){if(t.getAttribute("data-discount")=="Y"){var r=BX.findChild(BX.Sale.Admin.OrderEditPage.getForm(),{attribute:{"data-discount-id":t.getAttribute("data-discount-id")}},true,true);if(r.length>0){for(a=0;a<r.length;a++){r[a].checked=t.checked}}}}},refreshDiscounts:function(){if(this.discountRefreshTimeoutId>0)return;this.discountRefreshTimeoutId=setInterval(function(){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"DISCOUNTS_REFRESH"}));clearInterval(BX.Sale.Admin.OrderEditPage.discountRefreshTimeoutId);BX.Sale.Admin.OrderEditPage.discountRefreshTimeoutId=0},500)},ajaxRequests:{addProductToBasket:function(e,t,a,r){var i={action:"addProductToBasket",productId:e,quantity:t,replaceBasketCode:a?a:"",columns:r,callback:BX.Sale.Admin.OrderAjaxer.refreshOrderData.callback};return BX.Sale.Admin.OrderAjaxer.refreshOrderData.modifyParams(i)},cancelOrder:function(e,t,a){return{action:"cancelOrder",orderId:e,canceled:t,comment:a,callback:function(t){BX.Sale.Admin.OrderEditPage.unBlockForm();if(t&&!t.ERROR)BX.Sale.Admin.OrderEditPage.changeCancelBlock(e,t);else if(t&&t.ERROR)BX.Sale.Admin.OrderEditPage.showDialog(BX.message("SALE_ORDER_STATUS_CANCEL_ERROR")+": "+t.ERROR);else BX.debug(BX.message("SALE_ORDER_STATUS_CANCEL_ERROR"))}}},saveStatus:function(e,t){var a=BX(t);if(!a)BX.debug("Error getting select object with id: "+t);if(typeof a.value=="undefined")BX.debug("Error getting select value id: "+t);return{action:"saveStatus",orderId:e,statusId:a.value,callback:function(e){var t;e.CAN_USER_EDIT="Y";if(e&&e.CAN_USER_EDIT&&!e.ERROR){BX.Sale.Admin.OrderEditPage.callFieldsUpdaters({STATUS_ID:a.value});BX.Sale.Admin.OrderEditPage.disableSavingButtons(e.CAN_USER_EDIT!="Y");t=BX.message("SALE_ORDER_STATUS_CHANGED_SUCCESS")}else if(e&&e.ERROR){t=BX.message("SALE_ORDER_STATUS_CHANGE_ERROR")+": "+e.ERROR}else{t=BX.message("SALE_ORDER_STATUS_CHANGE_ERROR")}BX.Sale.Admin.OrderEditPage.showDialog(t)}}},getOrderFields:function(e,t){return{action:"getOrderFields",givenFields:e.givenFields,demandFields:e.demandFields,callback:function(e){if(e&&e.RESULT_FIELDS&&!e.ERROR){BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.RESULT_FIELDS);if(t){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}}else if(e&&e.ERROR){BX.debug("Error receiving fields: "+e.ERROR)}else{BX.debug("Error receiving fields!")}}}},refreshOrderData:function(e){if(!BX.Sale.Admin.OrderAjaxer.refreshOrderData.getFlag()){return BX.Sale.Admin.OrderAjaxer.refreshOrderData.modifyParams({action:"refreshOrderData",additional:e,callback:BX.Sale.Admin.OrderAjaxer.refreshOrderData.callback})}}}};
//# sourceMappingURL=order_edit.map.js