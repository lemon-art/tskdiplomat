BX.namespace("BX.Sale.Admin.OrderBasket");BX.Sale.Admin.OrderBasket=function(e){this.tableId=e.tableId;this.objName=e.objName;this.idPrefix=e.idPrefix;this.productMenu=e.productMenu;this.columnsCount=e.columnsCount;this.visibleColumns=e.visibleColumns;this.isShowXmlId=e.isShowXmlId;this.productsCount=0;this.customPrices={};this.createBasketBottom=e.createBasketBottom||false;this.createProductBasement=e.createProductBasement||false;this.discounts=e.discounts||false;this.iblocksSkuParams=e.iblocksSkuParams||{};this.mode=e.mode||"edit";this.unRemovableFields=e.unRemovableFields||[];if(e.iblocksSkuParams)for(var t in e.iblocksSkuParams)this.setIblocksSkuParams(t,e.iblocksSkuParams[t]);this.fieldsUpdaters={};if(!this.products)this.products={};if(e.productsOrder&&e.productsOrder.length)for(var t=0,i=e.productsOrder.length-1;t<=i;t++)if(!!e.products[e.productsOrder[t]])this.productSet(e.products[e.productsOrder[t]],true);if(this.createBasketBottom)this.createBottomRow();if(this.discounts)this.setDiscounts(this.discounts);if(e.totalBlockFields)this.totalBlock=new BX.Sale.Admin.OrderBasketEditTotal({fields:e.totalBlockFields})};BX.Sale.Admin.OrderBasket.prototype.getFieldsUpdaters=function(){return{SUM_PAID:{context:this,callback:this.setSumPaid},PAYABLE:{context:this,callback:this.setSumUnPaid},TOTAL_PRICES:{context:this,callback:this.setTotalPrices},DELIVERY_PRICE:{context:this,callback:this.setDeliveryPrice},DELIVERY_PRICE_DISCOUNT:{context:this,callback:this.setDeliveryPriceDiscount}}};BX.Sale.Admin.OrderBasket.prototype.setTotalPrices=function(e){this.totalBlock.setFieldValue("SUM_PAID",e.SUM_PAID);this.totalBlock.setFieldValue("SUM_UNPAID",e.SUM_UNPAID)};BX.Sale.Admin.OrderBasket.prototype.setDeliveryPrice=function(e){this.totalBlock.setFieldValue("PRICE_DELIVERY",e)};BX.Sale.Admin.OrderBasket.prototype.setDeliveryPriceDiscount=function(e){this.totalBlock.setFieldValue("PRICE_DELIVERY_DISCOUNTED",e)};BX.Sale.Admin.OrderBasket.prototype.setSumPaid=function(e){this.totalBlock.setFieldValue("SUM_PAID",e)};BX.Sale.Admin.OrderBasket.prototype.setSumUnPaid=function(e){this.totalBlock.setFieldValue("SUM_UNPAID",e)};BX.Sale.Admin.OrderBasket.prototype.showEmptyRow=function(){var e=BX(this.idPrefix+"sale-adm-order-edit-basket-empty-row");if(e)e.style.display=""};BX.Sale.Admin.OrderBasket.prototype.hideEmptyRow=function(){var e=BX(this.idPrefix+"sale-adm-order-edit-basket-empty-row");if(e)e.style.display="none"};BX.Sale.Admin.OrderBasket.prototype.createBottomRow=function(e){if(!this.createBasketBottom)return;var t=BX(this.tableId),i=BX.create("td",{html:'<strong style="margin-left: 10px;">'+BX.message("SALE_ORDER_BASKET_PROD_COUNT")+":&nbsp;"+'<span id="'+this.idPrefix+'sale-order-basket-products-count">'+this.productsCount+"</span>"+"</strong>"}),r=BX.create("td",{props:{id:this.idPrefix+"sale-order-basket-bottom-discounts"}}),a=BX.create("tbody",{props:{id:this.idPrefix+"sale-order-basket-bottom"},style:{textAlign:"left",borderBottom:"1px solid #DDD"},children:[BX.create("tr",{children:[i,r]})]});i.colSpan=this.mode=="view"?1:2;r.colSpan=this.columnsCount-1;t.appendChild(a)};BX.Sale.Admin.OrderBasket.prototype.setDiscounts=function(e){this.discounts=e;var t=BX(this.idPrefix+"sale-order-basket-bottom-discounts"),i=[];if(!e||!e.ORDER||!e.ORDER.DISCOUNT_LIST)return;for(var r=0,a=e.ORDER.DISCOUNT_LIST.length;r<a;r++){var s=e.ORDER.DISCOUNT_LIST[r];if(e.DISCOUNT_LIST&&e.DISCOUNT_LIST[s]&&e.DISCOUNT_LIST[s].ACTIONS_DESCR&&e.DISCOUNT_LIST[s].ACTIONS_DESCR.BASKET){i[r]=e.DISCOUNT_LIST[s];i[r].DESCR=e.DISCOUNT_LIST[s].ACTIONS_DESCR.BASKET}}if(t&&i){t.innerHTML="";t.appendChild(this.createDiscountsNodeBasket(i))}};BX.Sale.Admin.OrderBasket.prototype.createDiscountsNodeBasket=function(e){return BX.Sale.Admin.OrderEditPage.createDiscountsNode("","DISCOUNT_LIST",e,this.discounts,"VIEW")};BX.Sale.Admin.OrderBasket.prototype.getProductBasketCode=function(e){if(!e.BASKET_CODE){if(e.IS_SET_ITEM=="Y"){var t=new Date;e.BASKET_CODE="set_"+t.getTime()+Math.floor(Math.random()*1e3)}else{BX.debug("product.BASKET_CODE is undefined!")}}return e.BASKET_CODE};BX.Sale.Admin.OrderBasket.prototype.setProductsCount=function(e){if(!this.createBasketBottom)return;var t=BX(this.idPrefix+"sale-order-basket-products-count");if(t)t.innerHTML=e};BX.Sale.Admin.OrderBasket.prototype.productAdd=function(e){var t=this.getProductBasketCode(e),i=BX(this.createProductRowId(t,e));if(i)return;if(parseFloat(e.PRICE)!=parseFloat(e.PRICE_BASE))this.customPrices[t]=e.PRICE;i=this.createProductRow(t,e);var r=BX(this.tableId),a=null;if(this.createBasketBottom&&(a=BX(this.idPrefix+"sale-order-basket-bottom"))){r.insertBefore(i,a)}else{r.appendChild(i)}};BX.Sale.Admin.OrderBasket.prototype.productSet=function(e,t){var i=this.getProductBasketCode(e);if(this.productsCount<=0)this.hideEmptyRow();if(BX(this.createProductRowId(i,e))){if(t){this.productReplace(e,i)}else{this.setProductQuantity(i,this.roundQuantity(parseFloat(this.getProductQuantity(i))+parseFloat(e.QUANTITY)))}}else{this.productAdd(e);if(e.IS_SET_ITEM!="Y")this.setProductsCount(++this.productsCount)}if(e.SET_ITEMS&&e.SET_ITEMS.length)for(var r=e.SET_ITEMS.length-1;r>=0;r--)this.productSet(e.SET_ITEMS[r],true);this.setRowNumbers()};BX.Sale.Admin.OrderBasket.prototype.createDiscountCell=function(e){var t=BX.create("text",{html:"&nbsp"});if(this.discounts&&this.discounts.RESULT&&this.discounts.RESULT.BASKET){t=BX.Sale.Admin.OrderEditPage.createDiscountsNode(e,"BASKET",this.discounts.RESULT.BASKET[e]?this.discounts.RESULT.BASKET[e]:{},this.discounts,"VIEW")}var i=BX.create("td",{props:{id:this.idPrefix+"sale-order-basket-product-"+e+"-discount-cell"},children:[BX.create("div",{children:[t]})]});i.colSpan=this.columnsCount-1;i.style.borderTop="1px solid #ddd";return i};BX.Sale.Admin.OrderBasket.prototype.setIblocksSkuParams=function(e,t){if(!this.iblocksSkuParams)this.iblocksSkuParams={};if(!this.iblocksSkuParams[e])this.iblocksSkuParams[e]=t};BX.Sale.Admin.OrderBasket.prototype.createProductRowBasement=function(e,t){if(!this.createProductBasement)return;var i=null,r=BX.create("tr",{props:{id:this.idPrefix+"sale-order-basket-product-"+e+"-basement",className:"bdb-line"}}),a=this.createProductBasementSkuCell(e,t),s=this.createDiscountCell(e,t);if(a&&s){r.appendChild(a);r.appendChild(s);i=r}return i};BX.Sale.Admin.OrderBasket.prototype.createProductBasementSkuCell=function(e,t){var i=this.createSkuPropsTable(e,t),r=null;if(i){r=BX.create("td",{children:[i]})}return r};BX.Sale.Admin.OrderBasket.prototype.createProductRowId=function(e,t){var i=this.idPrefix+"sale-order-basket-product-"+e;if(t){if(t.IS_SET_ITEM=="Y"&&t.PARENT_OFFER_ID)i+="-"+t.PARENT_OFFER_ID}return i};BX.Sale.Admin.OrderBasket.prototype.createProductRow=function(e,t){var i,r=BX.create("tbody",{props:{id:this.createProductRowId(e,t)},style:{textAlign:"left",borderBottom:"1px solid #DDD"}}),a=this.createMenuCell(e,t),s=BX.create("tr");if(a){if(this.createProductBasement)a.rowSpan=2;s.appendChild(a)}var d,o=[];if(t.IS_SET_ITEM!="Y"){o=this.createHiddenFields(e,t);this.products[e]=t;r.setAttribute("data-basket-code",e);if(t.IS_SET_PARENT&&t.OLD_PARENT_ID)r.setAttribute("data-old-parent-id-parent",t.OLD_PARENT_ID)}else{BX.addClass(r,"bundle-child-"+t.OLD_PARENT_ID);BX.addClass(r,"basket-bundle-child-hidden");BX.addClass(r,"bundle-child")}for(var n in this.visibleColumns){i=this.createProductCell(e,t,n);if(i){if(o)while(d=o.pop())i.appendChild(d);s.appendChild(i)}}s.setAttribute("onmouseover",this.objName+".onProductRowMouseOver(this);");s.setAttribute("onmouseout",this.objName+".onProductRowMouseOut(this);");r.appendChild(s);if(this.createProductBasement&&((t.SKU_PROPS||t.PROPS&&t.PROPS.length>0&&this.mode=="view")&&t.IS_SET_ITEM!="Y")||t.DISCOUNTS){var l=this.createProductRowBasement(e,t);if(l)r.appendChild(l)}return r};BX.Sale.Admin.OrderBasket.prototype.createHiddenFields=function(e,t){return[]};BX.Sale.Admin.OrderBasket.prototype.createMenuCell=function(e,t){var i,r=this.createProductMenuContent(e,t);if(r.length<=0)return false;if(t.IS_SET_ITEM!="Y"){i=BX.create("span",{props:{className:"adm-s-order-item-title-icon"}});BX.bind(i,"click",BX.proxy(function(e){i.blur();BX.adminList.ShowMenu(i,r)},this))}else{i=BX.create("span",{html:"&nbsp;"})}return BX.create("td",{props:{className:"tac bdb-line",id:this.idPrefix+"sale-order-basket-product-"+e+"-menu"},children:[i]})};BX.Sale.Admin.OrderBasket.prototype.onHeadMenu=function(e){BX.adminList.ShowMenu(e,[{ICON:"view",TEXT:BX.message("SALE_ORDER_BASKET_ROW_SETTINGS"),ACTION:this.objName+".onSettings()",DEFAULT:true}])};BX.Sale.Admin.OrderBasket.prototype.setRowNumbers=function(){if(!this.visibleColumns["NUMBER"])return;var e=BX(this.tableId),t="",i=null,r=1;for(var a=0,s=e.tBodies.length;a<s;a++){if(BX.hasClass(e.tBodies[a],"bundle-child"))continue;t=e.tBodies[a].getAttribute("data-basket-code");if(!t)continue;i=BX(this.idPrefix+"sale_order_product_"+t+"_number");if(i)i.innerHTML=r++;else BX.debug("BX.Sale.Admin.OrderBasket.prototype.setRowNumbers can't find: "+t)}};BX.Sale.Admin.OrderBasket.prototype.createProductCell=function(e,t,i){var r=null,a=[],s=t[i],d="",o=this;switch(i){case"NUMBER":a.push(BX.create("span",{props:{id:t.IS_SET_ITEM!="Y"?this.idPrefix+"sale_order_product_"+e+"_number":"&nbsp;"},html:"&nbsp;"}));break;case"NAME":if(t.IS_SET_PARENT=="Y"&&t.SET_ITEMS){var n=BX.create("a",{props:{href:"javascript:void(0);",className:"dashed-link show-set-link"},html:BX.message("SALE_ORDER_BASKET_EXPAND")});BX.bind(n,"click",function(e){var i=e.target||e.srcElement;o.onToggleBundleChildren(t.OLD_PARENT_ID,i)});a.push(BX.create("div",{children:[n]}))}if(t.EDIT_PAGE_URL){u=BX.create("a",{props:{href:t.EDIT_PAGE_URL,target:"_blank"},html:BX.util.htmlspecialchars(s)})}else{u=BX.create("span",{style:{fontWeight:"bold"},html:BX.util.htmlspecialchars(t[i])})}a.push(u);break;case"QUANTITY":if(typeof t.MEASURE_TEXT!="undefined")a.push(document.createTextNode(" "+t.MEASURE_TEXT+" "));if(t.IS_SET_ITEM=="Y")a.push(BX.Sale.Admin.OrderBasket.prototype.createFieldQuantity(e,t,i));else a.push(this.createFieldQuantity(e,t,i));break;case"AVAILABLE":a.push(this.createTextField(e,t,i));break;case"PRICE":if(t.IS_SET_ITEM=="Y"){a.push(BX.Sale.Admin.OrderBasket.prototype.createFieldPrice(e,t,i))}else{var l=this.createFieldPrice(e,t,i);l.id=this.idPrefix+"sale-order-basket-product-"+e+"-price-cell";a.push(l)}break;case"SUM":var c=t.PRICE*t.QUANTITY;a.push(BX.create("strong",{props:{id:this.idPrefix+"sale_order_edit_product_"+e+"_summ"},html:BX.Sale.Admin.OrderEditPage.currencyFormat(c)}));break;case"IMAGE":a.push(this.createFieldImage(e,t,i));d="adm-s-order-table-ddi-table-img";break;case"PROPS":var u=this.createFieldSkuProps(e,t,i);if(u)a.push(u);break}if(i.indexOf("PROPERTY_")===0){var p="",S=i.substr("PROPERTY_".length);if(t.PRODUCT_PROPS_VALUES&&t.PRODUCT_PROPS_VALUES[i+"_VALUE"]){var f=[t.OFFERS_IBLOCK_ID,t.IBLOCK_ID];for(var E in f){var B=f[E];if(!B)continue;if(this.iblocksSkuParams[B]){for(var h in this.iblocksSkuParams[B]){if(this.iblocksSkuParams[B][h].CODE!=S)continue;if(!this.iblocksSkuParams[B][h].VALUES[t.PRODUCT_PROPS_VALUES[i+"_VALUE"]])continue;if(this.iblocksSkuParams[B][h].VALUES[t.PRODUCT_PROPS_VALUES[i+"_VALUE"]]["NAME"]&&this.iblocksSkuParams[B][h].VALUES[t.PRODUCT_PROPS_VALUES[i+"_VALUE"]]["NAME"].length>0){p=this.iblocksSkuParams[B][h].VALUES[t.PRODUCT_PROPS_VALUES[i+"_VALUE"]]["NAME"]}else{p=t.PRODUCT_PROPS_VALUES[i+"_VALUE"]}break}if(p.length>0)break}}if(p.length<=0)p=t.PRODUCT_PROPS_VALUES[i+"_VALUE"]}else{p=""}a.push(BX.create("span",{html:p}))}if(a.length>0){r=BX.create("td");if(d)BX.addClass(r,d);while(a.length>0)r.appendChild(a.pop());if(i=="NAME"){r.style.minWidth="250px";if(t.IS_SET_ITEM=="Y"){r.style.fontStyle="italic";r.style.paddingLeft="40px"}}}return r};BX.Sale.Admin.OrderBasket.prototype.onToggleBundleChildren=function(e,t){if(t.innerHTML==BX.message("SALE_ORDER_BASKET_TURN"))t.innerHTML=BX.message("SALE_ORDER_BASKET_EXPAND");else t.innerHTML=BX.message("SALE_ORDER_BASKET_TURN");var i=BX.findChildren(BX(this.tableId),{className:"bundle-child-"+e},true);for(var r in i)BX.toggleClass(i[r],"basket-bundle-child-hidden")};BX.Sale.Admin.OrderBasket.prototype.createSkuPropsTable=function(e,t){var i=BX.create("table"),r,a=[],s=null;if(t.SKU_PROPS){for(var d in t.SKU_PROPS){if(t.SKU_PROPS[d]["VALUE"]["PICT"])r='<div style="width: 17px; height: 17px; text-align: center; border: 1px solid gray;">'+'<img  width="17" height="17" src="'+t.SKU_PROPS[d]["VALUE"]["PICT"]+'">'+"</div>";else r='<div style="font-size: 9px; padding: 2px 5px; text-align: center; border: 1px solid gray;">'+t.SKU_PROPS[d]["VALUE"]["NAME"]+"</div>";var o=BX.create("td",{html:'<span style="color: gray; font-size: 11px">'+t.SKU_PROPS[d]["NAME"]+" </span>",style:{"text-align":"left"}});i.appendChild(BX.create("tr",{children:[o,BX.create("td",{html:r})]}));a.push(t.SKU_PROPS[d]["CODE"])}}if(t.PROPS){for(var n in t.PROPS){if(!t.PROPS[n]||a.indexOf(t.PROPS[n]["CODE"])!=-1)continue;if(!this.isShowXmlId&&t.PROPS[n]["CODE"]=="PRODUCT.XML_ID")continue;var o=BX.create("td",{html:'<span style="color: gray; font-size: 11px">'+t.PROPS[n]["NAME"]+" </span>",style:{"text-align":"left"}});var l=BX.create("tr",{children:[o,BX.create("td",{html:'<div style="font-size: 9px; padding: 2px 5px; text-align: center;">'+t.PROPS[n]["VALUE"]+"</div>"})]});i.appendChild(l)}}if(i.children.length)s=i;return s};BX.Sale.Admin.OrderBasket.prototype.createFieldSkuProps=function(e,t,i){return false};BX.Sale.Admin.OrderBasket.prototype.createFieldQuantity=function(e,t,i){return this.createTextField(e,t,i)};BX.Sale.Admin.OrderBasket.prototype.createFieldImage=function(e,t,i){var r,a;if(t.PICTURE_URL){r=BX.create("img",{props:{src:t.PICTURE_URL}})}else{r=BX.create("div",{props:{className:"no_foto"},text:BX.message("SALE_ORDER_BASKET_NO_PICTURE")})}if(typeof t.EDIT_PAGE_URL!="undefined"){a=BX.create("a",{props:{href:t.EDIT_PAGE_URL?t.EDIT_PAGE_URL:"",target:"_blank"},children:[r]});a.style.textAlign=this.mode=="edit"?"left":"center"}else{a=BX.create("span",{children:[r]})}return a};BX.Sale.Admin.OrderBasket.prototype.createFieldPrice=function(e,t,i){var r=BX.create("span",{props:{className:"view_price"}}),a="";if(typeof t.PRICE!="undefined"){a=BX.Sale.Admin.OrderEditPage.currencyFormat(t.PRICE)}r.appendChild(BX.create("div",{html:a}));if(a!=""){var s="none";if(parseFloat(t.PRICE_BASE)>0&&parseFloat(t.PRICE)!=parseFloat(t.PRICE_BASE))s="";var d=BX.create("div",{props:{className:"base_price"},style:{display:s},children:[BX.create("span",{html:BX.Sale.Admin.OrderEditPage.currencyFormat(t.PRICE_BASE)})]}),o=BX.create("div",{props:{className:"base_price_title"},style:{display:t.CUSTOM_PRICE&&t.CUSTOM_PRICE=="Y"||t.NOTES?"":"none"},text:t.CUSTOM_PRICE&&t.CUSTOM_PRICE=="Y"?BX.message("SALE_ORDER_BASKET_BASE_CATALOG_PRICE"):t.NOTES});r.appendChild(d);r.appendChild(o)}return r};BX.Sale.Admin.OrderBasket.prototype.createTextField=function(e,t,i){var r=typeof t[i]!="undefined"?t[i]:"";return BX.create("span",{text:r})};BX.Sale.Admin.OrderBasket.prototype.onSettings=function(){this.settingsDialog.show()};BX.Sale.Admin.OrderBasket.prototype.createProductMenuContent=function(e,t){return[]};BX.Sale.Admin.OrderBasket.prototype.onProductRowMouseOver=function(e){BX.addClass(e,"tr_hover")};BX.Sale.Admin.OrderBasket.prototype.onProductRowMouseOut=function(e){BX.removeClass(e,"tr_hover")};BX.Sale.Admin.OrderBasketEdit=function(e){this.productsOffersSkuParams={};this.productEditDialog=new BX.Sale.Admin.OrderBasketProductEditDialog(this);if(e.productsOffersSkuParams)for(var t in e.productsOffersSkuParams)this.setProductsOffersSkuParams(t,e.productsOffersSkuParams[t]);BX.Sale.Admin.OrderBasket.call(this,e);this.settingsDialog=new BX.Sale.Admin.OrderBasket.SettingsDialog({basket:this})};BX.Sale.Admin.OrderBasketEdit.prototype=Object.create(BX.Sale.Admin.OrderBasket.prototype);BX.Sale.Admin.OrderBasketEdit.prototype.getSkuPropsList=function(e,t,i){if(!this.productsOffersSkuParams[e])return;var r={},a=this.productsOffersSkuParams[e];for(var s in i)r[s]={};for(var d in a){if(!this.isOfferReachable(i,a[d]))continue;for(s in a[d])r[s][a[d][s]]=this.iblocksSkuParams[t][s]["VALUES"][a[d][s]]["NAME"]}return r};BX.Sale.Admin.OrderBasketEdit.prototype.getProductIdBySkuProps=function(e,t){if(!this.productsOffersSkuParams[e]){BX.debug("No such product: ".productId);return false}var i=0;for(var r in this.productsOffersSkuParams[e]){var a=true;for(var s in this.productsOffersSkuParams[e][r]){if(t[s]!=this.productsOffersSkuParams[e][r][s]){a=false;break}}if(a){i=r;break}}return i};BX.Sale.Admin.OrderBasketEdit.prototype.setBasket=function(e){if(!e)return;var t,i;if(e.IBLOCKS_SKU_PARAMS)for(t in e.IBLOCKS_SKU_PARAMS)if(!this.iblocksSkuParams[t])this.setIblocksSkuParams(t,e.IBLOCKS_SKU_PARAMS[t]);if(e.PRODUCTS_OFFERS_SKU)for(t in e.PRODUCTS_OFFERS_SKU)if(!this.productsOffersSkuParams[t])this.setProductsOffersSkuParams(t,e.PRODUCTS_OFFERS_SKU[t]);if(typeof e.WEIGHT_FOR_HUMAN!=="undefined")this.totalBlock.setFieldValue("WEIGHT",e.WEIGHT_FOR_HUMAN);if(e.PRICES_UPDATED){for(t in e.PRICES_UPDATED){var r=this.idPrefix+"sale-order-basket-product-"+t+"-price-cell",a=BX(r);if(!a)continue;if(this.customPrices[t])delete this.customPrices[t];var s=this.createFieldPrice(t,e.ITEMS[t]),d=a.parentNode;d.removeChild(a);d.appendChild(s);s.id=r;this.updateProductSumm(t)}for(t in e.ITEMS){r=this.idPrefix+"sale-order-basket-product-"+t+"-discount-cell";var o=BX(r);if(!o)continue;var n=this.createDiscountCell(t,e.ITEMS[t]),l=o.parentNode;l.removeChild(o);l.appendChild(n);n.id=r}if(e.NEW_ITEM_BASKET_CODE&&e.ITEMS[e.NEW_ITEM_BASKET_CODE])this.productSet(e.ITEMS[e.NEW_ITEM_BASKET_CODE],true)}else if(e.ITEMS_ORDER&&e.ITEMS_ORDER.length){for(t in this.products)this.productDelete(t);for(t=0,i=e.ITEMS_ORDER.length-1;t<=i;t++)this.productSet(e.ITEMS[e.ITEMS_ORDER[t]],true)}};BX.Sale.Admin.OrderBasketEdit.prototype.getParamsByProductId=function(e,t,i){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.addProductToBasket(e.id,e.quantity,e.replaceBasketCode,this.visibleColumns))};BX.Sale.Admin.OrderBasketEdit.prototype.createProductBasementSkuCell=function(e,t){var i=BX.create("td",{props:{id:this.idPrefix+"sale-order-basket-product-"+e+"-basement-sku"}}),r=BX.create("div",{props:{className:"adm-s-order-table-ddi-table-sku"}}),a=this.getSkuPropsList(t.PRODUCT_ID,t.OFFERS_IBLOCK_ID,t.SKU_PROPS);for(var s in a){var d=this.iblocksSkuParams[t.OFFERS_IBLOCK_ID][s]["NAME"],o=t.SKU_PROPS[s]["ID"];r.appendChild(this.createSkuSelector(e,s,d,o,a[s],t))}i.appendChild(r);return i};BX.Sale.Admin.OrderBasketEdit.prototype.createSkuSelector=function(e,t,i,r,a,s){var d=BX.create("ul",{attrs:{"data-sku-id":t}}),o="sku",n=0,l=0;for(var c in this.iblocksSkuParams[s.OFFERS_IBLOCK_ID][t]["ORDER"]){var u=this.iblocksSkuParams[s.OFFERS_IBLOCK_ID][t]["ORDER"][c];if(!a[u])continue;var p;if(this.iblocksSkuParams[s.OFFERS_IBLOCK_ID][t]["VALUES"][u]["PICT"]){p='<img  src="'+this.iblocksSkuParams[s.OFFERS_IBLOCK_ID][t]["VALUES"][u]["PICT"]+'">'}else{o="size";p=u}var S=BX.create("li",{attrs:{"data-value":u},children:[BX.create("span",{props:{className:"cnt"},html:p})]});if(u==r){BX.addClass(S,"bx-active");l=n}d.appendChild(S);BX.bind(S,"click",BX.delegate(function(i){var a=i.target||i.srcElement,o=a.parentNode.getAttribute("data-value")||a.parentNode.parentNode.getAttribute("data-value");if(o==r)return false;var n=this.getSkuProps(e,s.SKU_PROPS);n[t]=o;var l=this.getProductIdBySkuProps(s.PRODUCT_ID,n);for(var c in this.products){if(c==e)continue;if(this.products[c].OFFER_ID==l)if(!confirm(BX.message("SALE_ORDER_BASKET_POSITION_EXISTS").replace("#NAME#",this.products[c].NAME)))return}this.onSkuSelectorClick(e,d,t,o);this.onSkuPropSelect(s.PRODUCT_ID,e,s.SKU_PROPS)},this));n++}var f=BX.create("div",{props:{className:"adm-s-item-detail-"+o+"-box-arrow left"},events:{click:BX.delegate(function(){this.skuSelectorScrollLeft(d,n)},this)}}),E=BX.create("div",{props:{className:"adm-s-item-detail-"+o+"-box-arrow right"},events:{click:BX.delegate(function(){this.skuSelectorScrollRight(d,n)},this)}});var B=BX.create("div",{props:{className:"adm-s-item-detail-sku"},children:[BX.create("div",{props:{className:"adm-s-item-detail-"+o+"-title"},text:i}),f,E,BX.create("div",{props:{className:"adm-s-item-detail-"+o+"-box"},children:[BX.create("div",{props:{className:"adm-s-item-detail-"+o+"-box-container"},children:[d,BX.create("input",{props:{type:"hidden",name:this.getFieldName(e,"SKU")+"["+t+"]",value:r}})]})]})]});var h=-1*this.skuSelectorCountScrollOffset(l,n);this.skuSelectorSetScroll(d,h);this.skuSelectorSetArrowsVisibility(d,h,n);return B};BX.Sale.Admin.OrderBasketEdit.prototype.getFieldsUpdaters=function(){return{TOTAL_PRICES:{context:this,callback:this.setTotalPrices},BASKET:{context:this,callback:this.setBasket},SUM_PAID:{context:this,callback:this.setSumPaid},PAYABLE:{context:this,callback:this.setSumUnPaid},TAX_VALUE:{context:this,callback:this.setTaxValue},DELIVERY_PRICE:{context:this,callback:this.setDeliveryPrice},DELIVERY_PRICE_DISCOUNT:{context:this,callback:this.setDeliveryPriceDiscount},"SHIPMENT[1][PRICE_DELIVERY]":{context:this,callback:this.setDeliveryPrice},COUPONS_LIST:{context:this,callback:this.setCoupons},DISCOUNTS_LIST:{context:this,callback:this.setDiscounts}}};BX.Sale.Admin.OrderBasketEdit.prototype.getProductPrice=function(e){var t=BX.Sale.Admin.OrderEditPage.getForm();return t.elements[this.getFieldName(e,"PRICE")].value};BX.Sale.Admin.OrderBasketEdit.prototype.setCoupons=function(e){return BX.Sale.Admin.OrderBasketCoupons.setCoupons(e)};BX.Sale.Admin.OrderBasketEdit.prototype.getProductQuantity=function(e){var t=BX.Sale.Admin.OrderEditPage.getForm();return t.elements[this.getFieldName(e,"QUANTITY")].value};BX.Sale.Admin.OrderBasketEdit.prototype.setProductQuantity=function(e,t){var i=BX.Sale.Admin.OrderEditPage.getForm(),r=i.elements[this.getFieldName(e,"QUANTITY")];t=parseFloat(t);if(!t||t<0)t=0;else t=this.roundQuantity(t);if(r)r.value=t;this.onProductQuantityChange({productId:e});return t};BX.Sale.Admin.OrderBasketEdit.prototype.setProductPrice=function(e,t){var i=BX.Sale.Admin.OrderEditPage.getForm(),r=i.elements[this.getFieldName(e,"PRICE")],a=i.elements[this.getFieldName(e,"PRICE_BASE")],s=BX(this.idPrefix+"sale-order-basket-product-"+e+"-base_price"),d=BX(this.idPrefix+"sale-order-basket-product-"+e+"-formatted_price");t=parseFloat(t);if(!t||t<0)t=0;else t=parseFloat(t);if(r)r.value=t;if(d)d.innerHTML=BX.Sale.Admin.OrderEditPage.currencyFormat(t);if(a&&s){var o=parseFloat(a.value);if(o>0&&o!=t){s.style.display="";this.customPrices[e]=t}else{s.style.display="none"}}this.onProductPriceChange({productId:e});return t};BX.Sale.Admin.OrderBasketEdit.prototype.onProductQuantityChange=function(e){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater(this.getFieldName(e.productId,"QUANTITY"),e.productId)};BX.Sale.Admin.OrderBasketEdit.prototype.createSkuPropsTable=function(e,t){var i=BX.create("table"),r,a=0,s=[];if(t.SKU_PROPS){for(var d in t.SKU_PROPS){if(t.SKU_PROPS[d]["VALUE"]["PICT"])r='<div style="width: 17px; height: 17px; text-align: center; border: 1px solid gray;">'+'<img  width="17" height="17" src="'+t.SKU_PROPS[d]["VALUE"]["PICT"]+'">'+"</div>";else r='<div style="font-size: 9px; padding: 2px 5px; text-align: center; border: 1px solid gray;">'+t.SKU_PROPS[d]["VALUE"]["NAME"]+"</div>";i.appendChild(BX.create("tr",{children:[BX.create("td",{html:'<span style="color: gray; font-size: 11px">'+t.SKU_PROPS[d]["NAME"]+": </span>"}),BX.create("td",{html:r})]}));s.push(t.SKU_PROPS[d]["CODE"]);a++}}if(t.PROPS){for(var o in t.PROPS){if(!t.PROPS[o]||s.indexOf(t.PROPS[o]["CODE"])!=-1)continue;if(!t.PROPS[o]["NAME"])t.PROPS[o]["NAME"]="";if(!t.PROPS[o]["VALUE"])t.PROPS[o]["VALUE"]="";var n=BX.create("tr",{children:[BX.create("td",{html:'<span style="color: gray; font-size: 11px">'+BX.util.htmlspecialchars(t.PROPS[o]["NAME"])+": </span>"}),BX.create("td",{html:'<div style="font-size: 9px; padding: 2px 5px; text-align: center;">'+BX.util.htmlspecialchars(t.PROPS[o]["VALUE"])+"</div>"})]});if(!this.isShowXmlId&&t.PROPS[o]["CODE"]=="PRODUCT.XML_ID")n.style.display="none";i.appendChild(n);a++}}return i};BX.Sale.Admin.OrderBasketEdit.prototype.onProductPriceChange=function(e){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater(this.getFieldName(e.productId,"PRICE"),e.productId)};BX.Sale.Admin.OrderBasketEdit.prototype.updateProductQuantity=function(e){this.updateProductSumm(e);BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"FIELD_UPDATE",updatedFieldId:"QUANTITY",productId:e}))};BX.Sale.Admin.OrderBasketEdit.prototype.updateProductPrice=function(e){this.updateProductSumm(e);BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"FIELD_UPDATE",updatedFieldId:"PRICE",productId:e}))};BX.Sale.Admin.OrderBasketEdit.prototype.updateProductSumm=function(e){var t=BX(this.idPrefix+"sale_order_edit_product_"+e+"_summ");if(!t)return;t.innerHTML=BX.Sale.Admin.OrderEditPage.currencyFormat(this.getProductPrice(e)*this.getProductQuantity(e))};BX.Sale.Admin.OrderBasketEdit.prototype.setTotalPrices=function(e){this.totalBlock.setFieldValue("PRICE_BASKET",e.PRICE_BASKET);this.totalBlock.setFieldValue("PRICE_BASKET_DISCOUNTED",e.PRICE_BASKET_DISCOUNTED);this.totalBlock.setFieldValue("PRICE_DELIVERY",e.PRICE_DELIVERY);this.totalBlock.setFieldValue("PRICE_DELIVERY_DISCOUNTED",e.PRICE_DELIVERY_DISCOUNTED);this.totalBlock.setFieldValue("TAX_VALUE",e.TAX_VALUE);this.totalBlock.setFieldValue("SUM_PAID",e.SUM_PAID);this.totalBlock.setFieldValue("SUM_UNPAID",e.SUM_UNPAID)};BX.Sale.Admin.OrderBasketEdit.prototype.setDeliveryPrice=function(e){this.totalBlock.setFieldValue("PRICE_DELIVERY",e)};BX.Sale.Admin.OrderBasketEdit.prototype.setDeliveryPriceDiscount=function(e){this.totalBlock.setFieldValue("PRICE_DELIVERY_DISCOUNTED",e)};BX.Sale.Admin.OrderBasketEdit.prototype.setTaxValue=function(e){this.totalBlock.setFieldValue("TAX_VALUE",e)};BX.Sale.Admin.OrderBasketEdit.prototype.addProductSearch=function(e){var t=this.objName+".getParamsByProductId";window[t]=BX.proxy(function(e,t){this.getParamsByProductId(e,t)},this);var i=new BX.CDialog({content_url:"/bitrix/admin/cat_product_search_dialog.php?"+"lang="+BX.Sale.Admin.OrderEditPage.languageId+"&LID="+BX.Sale.Admin.OrderEditPage.siteId+"&caller=order_edit"+"&func_name="+t+"&STORE_FROM_ID=0",height:Math.max(500,window.innerHeight-400),width:Math.max(800,window.innerWidth-400),draggable:true,resizable:true,min_height:500,min_width:800});BX.addCustomEvent(i,"onWindowRegister",BX.defer(function(){i.Get().style.position="fixed";i.Get().style.top=parseInt(i.Get().style.top)-BX.GetWindowScrollPos().scrollTop+"px"}));i.Show()};BX.Sale.Admin.OrderBasketEdit.prototype.getCoupons=function(){var e=BX.Sale.Admin.OrderEditPage.getForm();return e.elements["COUPONS"].value};BX.Sale.Admin.OrderBasketEdit.prototype.onSkuPropSelect=function(e,t,i){var r=this.getSkuProps(t,i);var a=this.getProductIdBySkuProps(e,r);this.getParamsByProductId({id:a,quantity:this.getProductQuantity(t),replaceBasketCode:t},0)};BX.Sale.Admin.OrderBasketEdit.prototype.getSkuProps=function(e,t){var i={},r=BX.Sale.Admin.OrderEditPage.getForm();for(var a in t)i[a]=r.elements[this.getFieldName(e,"SKU")+"["+a+"]"].value;return i};BX.Sale.Admin.OrderBasketEdit.prototype.isOfferReachable=function(e,t){if(!e)return false;var i=0;for(var r in e){if(!t[r])return false;if(e[r]["ID"]!=t[r])i++;if(i>1)return false}return true};BX.Sale.Admin.OrderBasketEdit.prototype.getFieldName=function(e,t){return"PRODUCT["+e+"]["+t+"]"};BX.Sale.Admin.OrderBasketEdit.prototype.productReplace=function(e,t){var i=BX(this.createProductRowId(t,e));if(!i)return;this.onProductDelete(t);var r=this.getProductBasketCode(e),a=this.createProductRow(r,e);if(!a)return;if(!BX.hasClass(i,"basket-bundle-child-hidden"))BX.removeClass(a,"basket-bundle-child-hidden");i.parentNode.replaceChild(a,i);this.setRowNumbers()};BX.Sale.Admin.OrderBasketEdit.prototype.onProductDelete=function(e){BX.Sale.Admin.OrderEditPage.unRegisterProductFieldsUpdaters(e)};BX.Sale.Admin.OrderBasketEdit.prototype.productDeleteClick=function(e){this.productDelete(e);BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"PRODUCT_DELETE",productId:e}))};BX.Sale.Admin.OrderBasketEdit.prototype.productDelete=function(e){var t=BX(this.createProductRowId(e));if(!t)return;var i=t.getAttribute("data-old-parent-id-parent");if(i){var r=BX.findChildren(t.parentNode,{className:"bundle-child-"+i},false);for(var a in r)r[a].parentNode.removeChild(r[a])}this.onProductDelete(e);t.parentNode.removeChild(t);this.setRowNumbers();this.setProductsCount(--this.productsCount);if(this.productsCount<=0)this.showEmptyRow();if(this.customPrices[e])delete this.customPrices[e];delete this.products[e]};BX.Sale.Admin.OrderBasketEdit.prototype.onSkuSelectorClick=function(e,t,i,r){for(var a=0,s=t.children.length;a<s;a++){var d=t.children[a];if(d.getAttribute("data-value")!=r)BX.removeClass(d,"bx-active");else BX.addClass(d,"bx-active")}this.setSkuInput(e,i,r)};BX.Sale.Admin.OrderBasketEdit.prototype.setSkuInput=function(e,t,i){var r=this.getFieldName(e,"SKU")+"["+t+"]",a=BX.Sale.Admin.OrderEditPage.getForm();a.elements[r].value=i};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorSetArrowsVisibility=function(e,t,i){var r=e.parentNode.parentNode.parentNode.childNodes[1];if(i<=5||t>=0)r.style.display="none";else r.style.display="";var a=e.parentNode.parentNode.parentNode.childNodes[2];if(i<=5||t<=5-i)a.style.display="none";else a.style.display=""};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorScrollLeft=function(e,t){var i=this.skuSelectorGetScrollOffset(e);if(i>=0)return false;this.skuSelectorSetScroll(e,++i);this.skuSelectorSetArrowsVisibility(e,i);return true};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorScrollRight=function(e,t){var i=this.skuSelectorGetScrollOffset(e);if(i<=5-t)return false;this.skuSelectorSetScroll(e,--i);this.skuSelectorSetArrowsVisibility(e,i,t);return true};BX.Sale.Admin.OrderBasketEdit.prototype.createDiscountCell=function(e,t){var i=BX.create("text",{html:"&nbsp"});if(this.discounts&&this.discounts.RESULT&&this.discounts.RESULT.BASKET){i=BX.Sale.Admin.OrderEditPage.createDiscountsNode(e,"BASKET",this.discounts.RESULT.BASKET[e]?this.discounts.RESULT.BASKET[e]:{},this.discounts,"EDIT")}var r=BX.create("td",{props:{id:this.idPrefix+"sale-order-basket-product-"+e+"-discount-cell"},children:[BX.create("div",{children:[i]})]});r.colSpan=this.columnsCount-1;r.style.borderTop="1px solid #ddd";return r};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorCountScrollOffset=function(e,t){var i=0;e=e+1;if(t>5&&e>2){var r=t-e;i=e-3;if(r<2)i=i-(2-r)}return i};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorGetStepSize=function(){return 30};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorGetScrollOffset=function(e){if(!e)return false;var t=parseInt(e.style.marginLeft,10);if(!t)t=0;else t=parseInt(t/this.skuSelectorGetStepSize(),10);return t};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorSetScroll=function(e,t){e.style.marginLeft=t*this.skuSelectorGetStepSize()+"px"};BX.Sale.Admin.OrderBasketEdit.prototype.onCouponsRecount=function(){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"COUPONS_RECOUNT"}))};BX.Sale.Admin.OrderBasketEdit.prototype.createProductMenuContent=function(e){return[{ICON:"view",TEXT:BX.message("SALE_ORDER_BASKET_PROD_MENU_EDIT"),ACTION:this.objName+'.productEdit("'+e+'")',DEFAULT:true},{ICON:"delete",TEXT:BX.message("SALE_ORDER_BASKET_PROD_MENU_DELETE"),ACTION:this.objName+'.productDeleteClick("'+e+'")'}]};BX.Sale.Admin.OrderBasketEdit.prototype.productEdit=function(e){this.productEditDialog.show(e)};BX.Sale.Admin.OrderBasketEdit.prototype.roundQuantity=function(e){return e;

};BX.Sale.Admin.OrderBasketEdit.prototype.createMeasureRatioNode=function(e,t,i){if(!t||typeof t.value=="undefined")return null;if(!i||i==1)return null;var r=BX.create("a",{props:{href:"javascript:void(0);",title:BX.message("SALE_ORDER_BASKET_UP_RATIO").replace("#RATIO#",i),className:"plus"}}),a=BX.create("a",{props:{href:"javascript:void(0);",title:BX.message("SALE_ORDER_BASKET_DOWN_RATIO").replace("#RATIO#",i),className:"minus"}}),s=this;BX.bind(r,"click",function(r){t.value=s.roundQuantity(parseFloat(t.value)+parseFloat(i));s.onProductQuantityChange({productId:e})});BX.bind(a,"click",function(r){t.value=s.roundQuantity(parseFloat(t.value)-parseFloat(i));s.onProductQuantityChange({productId:e})});var d=BX.create("div",{props:{className:"quantity_control"},children:[r,a]});d.style.position="inherit";d.style.marginLeft="3px";return d};BX.Sale.Admin.OrderBasketEdit.prototype.createFieldQuantity=function(e,t,i){var r=typeof t.MEASURE_RATIO!="undefined"?t.MEASURE_RATIO:1,a={},s,d=this,o=BX.create("input",{props:{type:"text",name:this.getFieldName(e,"QUANTITY"),value:this.roundQuantity(t.QUANTITY),className:"tac"}}),n=this.createMeasureRatioNode(e,o,r);o.style.width="60px";BX.bind(o,"change",function(t){d.setProductQuantity(e,o.value)});BX.bind(o,"keydown",function(e){if(!e)e=window.event;if(!e)return;if(e.keyCode==13)o.blur()});a[this.getFieldName(e,"QUANTITY")]={callback:d.updateProductQuantity,context:d};BX.Sale.Admin.OrderEditPage.registerFieldsUpdaters(a);if(n){s=BX.create("span",{children:[o,n]});s.style.display="inline-flex"}else{s=o}return s};BX.Sale.Admin.OrderBasketEdit.prototype.createFieldPrice=function(e,t,i){var r;if(typeof this.customPrices[e]=="undefined")r=t.PRICE;else r=this.customPrices[e];var a={},s=this,d=BX.create("input",{props:{type:"text",name:this.getFieldName(e,"PRICE"),value:r,maxlength:"9",size:5}}),o=BX.create("span",{props:{className:"edit_price_product"},children:[d]}),n=BX.create("span",{props:{className:"formated_price",id:this.idPrefix+"sale-order-basket-product-"+e+"-formatted_price"},html:BX.Sale.Admin.OrderEditPage.currencyFormat(r)}),l=BX.create("span",{props:{className:"default_price_product"},children:[n]}),c=BX.create("span",{text:""}),u=BX.create("a",{props:{href:"javascript:void(0);"},children:[BX.create("span",{props:{className:"pencil"}})]}),p=BX.create("div",{props:{className:"base_price",id:this.idPrefix+"sale-order-basket-product-"+e+"-base_price"},style:{display:parseFloat(t.PRICE_BASE)>0&&parseFloat(t.PRICE)!=parseFloat(t.PRICE_BASE)?"":"none"},children:[BX.create("span",{html:BX.Sale.Admin.OrderEditPage.currencyFormat(t.PRICE_BASE)})]}),S=BX.create("div",{props:{className:"base_price_title"},style:{display:t.CUSTOM_PRICE&&t.CUSTOM_PRICE=="Y"||t.NOTES?"":"none"},text:t.CUSTOM_PRICE&&t.CUSTOM_PRICE=="Y"?BX.message("SALE_ORDER_BASKET_BASE_CATALOG_PRICE"):t.NOTES}),f=BX.create("span",{props:{className:"edit_price"},children:[l,o,c,u,p,S]});d.style.width="60px";BX.bind(u,"click",function(e){s.onPriceEditEnable(f,d)});BX.bind(n,"click",function(e){s.onPriceEditEnable(f,d)});BX.bind(d,"change",function(t){var i=BX.Sale.Admin.OrderEditPage.getForm();i.elements[s.getFieldName(e,"CUSTOM_PRICE")].value="Y";var r=s.setProductPrice(e,d.value);n.innerHTML=BX.Sale.Admin.OrderEditPage.currencyFormat(r)});BX.bind(d,"keydown",function(e){if(!e)e=window.event;if(!e)return;if(e.keyCode==13)d.blur()});BX.bind(d,"blur",function(e){s.onPriceEditDisable(f)});a[this.getFieldName(e,"PRICE")]={callback:s.updateProductPrice,context:s};BX.Sale.Admin.OrderEditPage.registerFieldsUpdaters(a);return f};BX.Sale.Admin.OrderBasketEdit.prototype.createFieldSkuProps=function(e,t){return this.createSkuPropsTable(e,t)};BX.Sale.Admin.OrderBasketEdit.prototype.createDiscountsNodeBasket=function(e){return BX.Sale.Admin.OrderEditPage.createDiscountsNode("","DISCOUNT_LIST",e,this.discounts,"EDIT")};BX.Sale.Admin.OrderBasketEdit.prototype.getHiddenFieldsNames=function(){return["CURRENCY","PRODUCT_PROVIDER_CLASS","NAME","DETAIL_PAGE_URL","WEIGHT","CATALOG_XML_ID","NOTES","PRODUCT_XML_ID","OFFER_ID","MODULE","CUSTOM_PRICE","IS_SET_ITEM","IS_SET_PARENT","MEASURE_CODE"]};BX.Sale.Admin.OrderBasketEdit.prototype.createHiddenFields=function(e,t){var i=[];if(typeof t["CUSTOM_PRICE"]=="undefined")t["CUSTOM_PRICE"]="N";for(var r in t){if(!t[r]&&r!="CATALOG_XML_ID")continue;if(r=="PROPS"){i.push(BX.create("span",{html:this.createSkuPropsHiddenHtml(e,t["PROPS"],t.IS_SET_ITEM,"PROPS")}));continue}if(r=="SKU_PROPS"){i.push(BX.create("span",{html:this.createSkuPropsHiddenHtml(e,t["SKU_PROPS"],t.IS_SET_ITEM,"SKU_PROPS")}));continue}if(typeof t[r]=="object")continue;if(r=="PRICE"||r=="QUANTITY")continue;i.push(BX.create("input",{props:{type:"hidden",name:this.getFieldName(e,r),value:t[r]}}))}return i};BX.Sale.Admin.OrderBasketEdit.prototype.createSkuPropsHiddenHtml=function(e,t,i,r){if(!t)return"";var a=0,s=this.getFieldName(e,r),d=[],o="";if(t){for(var n in t){if(!t[n]||d.indexOf(t[n]["CODE"])!=-1)continue;if(i!="Y"){var l=t[n]["NAME"]?BX.util.htmlspecialchars(t[n]["NAME"]):"",c=t[n]["VALUE"]?BX.util.htmlspecialchars(t[n]["VALUE"]):"",u=t[n]["CODE"]?BX.util.htmlspecialchars(t[n]["CODE"]):"",p=t[n]["SORT"]?BX.util.htmlspecialchars(t[n]["SORT"]):100;o+='<input type="hidden" name="'+s+"["+a+'][NAME]" value="'+l+'">'+'<input type="hidden" name="'+s+"["+a+'][VALUE]" value="'+c+'">'+'<input type="hidden" name="'+s+"["+a+'][CODE]" value="'+u+'">'+'<input type="hidden" name="'+s+"["+a+'][SORT]" value="'+p+'">'}a++}}return o};BX.Sale.Admin.OrderBasketEdit.prototype.setProductsOffersSkuParams=function(e,t){if(!this.productsOffersSkuParams)this.productsOffersSkuParams={};if(!this.productsOffersSkuParams[e])this.productsOffersSkuParams[e]=t};BX.Sale.Admin.OrderBasketEdit.prototype.onPriceEditEnable=function(e,t){BX.addClass(e,"edit_enable");t.focus()};BX.Sale.Admin.OrderBasketEdit.prototype.onPriceEditDisable=function(e){BX.removeClass(e,"edit_enable")};BX.Sale.Admin.OrderBasketEdit.prototype.addFieldUpdater=function(e,t,i){if(!this.fieldsUpdaters[e])this.fieldsUpdaters[e]={};if(!this.fieldsUpdaters[e][t])this.fieldsUpdaters[e][t]=[];if(typeof i=="function")this.fieldsUpdaters[e][t].push(i);else BX.debug("BX.Sale.Admin.OrderBasketEdit.prototype.addFieldUpdater() callback is not a function!")};BX.Sale.Admin.OrderBasketEdit.prototype.callFieldUpdaters=function(e,t,i){if(!this.fieldsUpdaters[e])return false;if(!this.fieldsUpdaters[e][t])return false;var r=this.fieldsUpdaters[e][t];for(var a in r){if(typeof r[a]!="function")continue;r[a].call(this,i)}};BX.Sale.Admin.OrderBasketEdit.prototype.setProductFieldValue=function(e,t,i){var r=BX.Sale.Admin.OrderEditPage.getForm(),a=r.elements[this.getFieldName(e,t)];if(a&&a.value)a.value=i;if(this.fieldsUpdaters[e]&&this.fieldsUpdaters[e][t]&&typeof this.fieldsUpdaters[e][t]=="function"){this.fieldsUpdaters[e][t].call(this,i)}};BX.Sale.Admin.OrderBasketEdit.prototype.getProductFieldValue=function(e,t){var i=BX.Sale.Admin.OrderEditPage.getForm();if(!i)return"";var r="",a=i.elements[this.getFieldName(e,t)];if(a&&a.value)r=a.value;return r};BX.Sale.Admin.OrderBasketEditTotal=function(params){if(!params.fields){BX.debug("OrderBasketEditTotal:constructor() params.fields not defined!");return}this.fields={};this.formulas={};var _this=this;var getUnitOfMesure=function(e){var t=_this.fields[e]["type"],i="";if(t=="currency")i=BX.Sale.Admin.OrderEditPage.currencyLang;else if(t=="weight")i=BX.message("SALE_ORDER_BASKET_KG");return i};var getFormattedValue=function(e){var t=_this.fields[e]["value"],i=_this.fields[e]["type"],r=t;if(i=="currency")r=BX.Sale.Admin.OrderEditPage.currencyFormat(t,true);else if(i=="weight")r=t;return r};var setFieldView=function(e){var t=BX(_this.fields[e].id);if(!t){BX.debug("OrderBasketEditTotal:setFieldView() can't find field with id: \""+_this.fields[e].id+'"');return false}if(_this.fields[e]["edit"]){var i=BX.findChild(t,{className:"formated_field_view"},true,false);if(i)i.innerHTML=getFormattedValue(e)}else{t.innerHTML=getFormattedValue(e)+" "+getUnitOfMesure(e)}return true};var setFieldEditable=function(e){var t=BX(_this.fields[e].id);if(!t){BX.debug("OrderBasketEditTotal:setFieldView() can't find field with id: \""+_this.fields[e].id+'"');return false}var i=BX.create("input",{props:{type:"text",name:e,value:_this.fields[e].value,maxlength:"9",size:5}}),r=BX.create("span",{props:{className:"edit_field"},children:[i]}),a=BX.create("span",{props:{className:"formated_field_view"},html:getFormattedValue(e)}),s=BX.create("span",{props:{className:"view_field"},children:[a]}),d=BX.create("span",{text:" "+getUnitOfMesure(e)+" "}),o=BX.create("a",{props:{href:"javascript:void(0);"},children:[BX.create("span",{props:{className:"pencil"}})]}),n=BX.create("span",{props:{className:"edit_field_container"},children:[s,r,d,o]});i.style.width="40px";BX.bind(i,"change",function(t){_this.setFieldValue(e,this.value)});BX.bind(t,"mouseover",function(e){BX.addClass(t,"edit_field_hover")});BX.bind(t,"mouseout",function(e){BX.removeClass(t,"edit_field_hover")});BX.bind(t,"click",function(e){BX.addClass(t,"edit_enabled");i.focus()});BX.bind(i,"blur",function(e){BX.removeClass(t,"edit_enabled")});t.innerHTML="";t.appendChild(n)};var setFormulas=function(e){_this.formulas[e]=_this.fields[e]["formula"]};var getFormulas=function(e){var t=[];for(var i in _this.formulas){var r=new RegExp("\\W*"+e+"\\W*","i");if(_this.formulas[i].search(r)!=-1)t.push(i)}return t};var recountFormulasFieldsValues=function(fieldsIds){for(var i in fieldsIds){var formula=_this.formulas[fieldsIds[i]],re=new RegExp("[\\w_]+","ig"),newFormula=formula.replace(re,function(e){var t=_this.getFieldValue(e);return t});_this.setFieldValue(fieldsIds[i],eval(newFormula))}};var setField=function(e,t){var i=new RegExp("[^\\w_]+","ig");if(e.search(i)!=-1)BX.debug("OrderBasketEditTotal:setField() wrong field id!");_this.fields[e]=t;if(t.edit)setFieldEditable(e);if(t.formula)setFormulas(e)};for(var fieldId in params.fields)setField(fieldId,params.fields[fieldId]);this.setFieldValue=function(e,t){if(typeof _this.fields[e]!="undefined"){_this.fields[e].value=t;if(typeof _this.fields[e]["type"]["formula"]!="undefined"){var i=getFormulas(e);if(i)recountFormulasFieldsValues(i)}if(_this.fields[e]["type"]!="hidden")setFieldView(e,t)}else{BX.debug('OrderBasketEditTotal:setFieldValue() unknown field id: "'+e+'"')}};this.getFieldValue=function(e){var t=false;if(typeof this.fields[e]!="undefined")t=this.fields[e].value;else BX.debug('OrderBasketEditTotal: unknown field id: "'+e+'"');return t}};BX.Sale.Admin.OrderBasketProductEditDialog=function(e){var t=null,i=0,r=0,a=true,s=e,d=["CURRENCY","PRODUCT_PROVIDER_CLASS","NAME","DETAIL_PAGE_URL","WEIGHT","CATALOG_XML_ID","NOTES","PRODUCT_XML_ID","OFFER_ID","PRICE","QUANTITY","PROPS","MEASURE_CODE","CUSTOM_PRICE"],o=this;var n=function(e){if(!e)e=S();i=e};var l=function(){return i};var c=function(){var e=BX("BASKET_PROP_TABLE");if(!e)BX.debug("BX.Sale.Admin.OrderBasketProductEditDialog:addPropRow() can't find props table!");return e};var u=function(e,t){return"FORM_PROD_PROP_"+l()+"_"+e+"_"+t};var p=function(e){return BX("FORM_PROD_BASKET_"+e)};var S=function(){var e=0;do{e++}while(typeof s.products[e]!="undefined");return e};var f=function(){var e=[],t=["NAME","VALUE","CODE","SORT"];for(var i=0;i<r;i++){var a={};for(var s=0;s<t.length;s++){var d=u(t[s],i),o=BX(d);if(o&&typeof o.value!="undefined")a[t[s]]=o.value}e.unshift(a)}return e};var E=function(e){var t=f();e.PROPS=[];for(var i in t)if(t[i].NAME)e.PROPS.push(t[i]);return e};var B=function(){var e=l(),t,i=s.products[e]?s.products[e]:{MODULE:"",OFFER_ID:S(),BASKET_CODE:e},r=false;for(var o in d){if(t=p(d[o])){if(d[o]=="PRICE"){var n=Math.round(parseFloat(i[d[o]])*1e4),c=Math.round(parseFloat(t.value)*1e4);if(n!=c){i["CUSTOM_PRICE"]="Y";r=true}}else if(d[o]=="CUSTOM_PRICE"){if(r)continue}i[d[o]]=t.value}}if(a)i.OFFER_ID=S();i=E(i);s.productSet(i,!a);BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"PRODUCT_ADD",productId:e}))};var h=function(){var e=s.products[l()];if(!e){BX.debug("BX.Sale.Admin.OrderBasketProductEditDialog.getProps() can't find product with basket code: \""+l()+'"');return[]}return s.products[l()]["PROPS"]};var m=function(){var e;for(var t in d){if(d[t]=="PROPS"){var i=h();for(var r in i)o.addPropRow(r,i[r])}else if(e=p(d[t])){e.value=s.getProductFieldValue(l(),d[t])}}BX("FORM_PROD_BASKET_MEASURE_CODE").disabled=s.getProductFieldValue(l(),"PRODUCT_PROVIDER_CLASS")!=""};var P=function(){var e;for(var t in d)if(e=p(d[t]))e.value="";var i=c();for(t=i.rows.length-1;t>1;t--)i.deleteRow(t);BX("FORM_PROD_BASKET_EMPTY_PROP_ROW").style.display=""};var O=function(){var e={action:"getProductEditDialogHtml",currency:BX.Sale.Admin.OrderEditPage.currencyLang,objName:s.objName,callback:function(e){if(e&&e.DIALOG_CONTENT&&!e.ERROR)_(e.DIALOG_CONTENT);else if(e&&e.ERROR)BX.debug("Error receiving dialog content: "+e.ERROR);else BX.debug("Error receiving dialog content!")}};BX.Sale.Admin.OrderAjaxer.sendRequest(e)};var _=function(e){t=new BX.CDialog({content:e,title:!a?BX.message("SALE_ORDER_BASKET_PROD_EDIT"):BX.message("SALE_ORDER_BASKET_PROD_CREATE"),width:820,height:470});t.ClearButtons();t.SetButtons([{title:BX.message("SALE_ORDER_BASKET_PROD_EDIT_ITEM_SAVE"),id:"save_custom_product",action:function(){B();this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]);if(!a)m();s.productEditDialog.disableButton();t.Show();BX.Sale.Admin.OrderEditPage.unBlockForm()};this.show=function(e){r=0;if(e)a=false;else a=true;n(e);if(t==null){t=O()}else{var i;if(!a){P();m();i=BX.message("SALE_ORDER_BASKET_PROD_EDIT")}else{P();i=BX.message("SALE_ORDER_BASKET_PROD_CREATE")}t.SetTitle(i);this.disableButton();t.Show();t.adjustSize()}};this.disableButton=function(){var e=BX("save_custom_product");if(!e)return;if(this.checkRequiredFields())e.disabled=false;else e.disabled=true};this.checkRequiredFields=function(){var e=BX("FORM_PROD_BASKET_NAME"),t=BX("FORM_PROD_BASKET_PRICE"),i=BX("FORM_PROD_BASKET_QUANTITY");if(i.value.length>0&&/\D/.test(i.value))i.value=parseFloat(i.value)||"0";if(t.value.length>0&&/\D/.test(t.value))t.value=parseFloat(t.value)||"0";if(e.value.length<=0)return false;if(t.value.length<=0)return false;if(i.value.length<=0)return false;return true};this.addPropRow=function(e,t){var i=c();if(!e)e=r;if(r<=0)BX("FORM_PROD_BASKET_EMPTY_PROP_ROW").style.display="none";var a={NAME:20,VALUE:20,CODE:3,SORT:2};if(!t)t={NAME:"",VALUE:"",CODE:"",SORT:""};var s=i.insertRow(-1),d=s.insertCell(-1),o=t["NAME"]?BX.util.htmlspecialchars(t["NAME"]):"",n=t["VALUE"]?BX.util.htmlspecialchars(t["VALUE"]):"",l=t["CODE"]?BX.util.htmlspecialchars(t["CODE"]):"",p=t["SORT"]?BX.util.htmlspecialchars(t["SORT"]):100;d.innerHTML='<input type="text" maxlength="250" size="'+a["NAME"]+'" name="'+u("NAME",e)+'" id="'+u("NAME",e)+'" value="'+o+'" />';d=s.insertCell(-1);d.innerHTML='<input type="text" maxlength="250" size="'+a["VALUE"]+'" name="'+u("VALUE",e)+'" id="'+u("VALUE",e)+'" value="'+n+'" />';d=s.insertCell(-1);d.innerHTML='<input type="text" maxlength="250" size="'+a["CODE"]+'" name="'+u("CODE",e)+'" id="'+u("CODE",e)+'" value="'+l+'" />';d=s.insertCell(-1);d.innerHTML='<input type="text" maxlength="250" size="'+a["SORT"]+'" name="'+u("SORT",e)+'" id="'+u("SORT",e)+'" value="'+p+'" />';r++}};BX.Sale.Admin.OrderBasketCoupons={MODES_LIST:{CREATE:0,EDIT:1,VIEW:2},statusCouponApplyed:null,mode:null,getCouponsContainerNode:function(){return BX("sale-admin-order-coupons-container")},onSetCoupon:function(e,t){BX.Sale.Admin.OrderEditPage.setDiscountCheckbox(t);BX.Sale.Admin.OrderEditPage.refreshDiscounts()},onDeleteCoupon:function(e){BX.Sale.Admin.OrderAjaxer.sendRequest({action:"deleteCoupon",coupon:e,orderId:BX.Sale.Admin.OrderEditPage.orderId,userId:BX.Sale.Admin.OrderBuyer.getBuyerId(),callback:function(e){if(e&&e.ERROR)BX.Sale.Admin.OrderEditPage.showDialog("Error: can't delete coupon")}},false,true)},onAddCoupons:function(){var e=BX("sale-admin-order-coupons");if(!e||!e.value)return;BX.Sale.Admin.OrderAjaxer.sendRequest({action:"addCoupons",coupon:e.value,orderId:BX.Sale.Admin.OrderEditPage.orderId,userId:BX.Sale.Admin.OrderBuyer.getBuyerId(),callback:function(e){if(e&&e.ERROR)BX.Sale.Admin.OrderEditPage.showDialog("Error during adding coupons")}},false,true);e.value=""},addCouponRow:function(e){var t=this.getCouponsContainerNode();if(!t)return;var i={toUse:e.JS_STATUS==="APPLYED",description:e.DISCOUNT_NAME!=""?e.DISCOUNT_NAME:e.COUPON,coupon:e.COUPON,title:e.JS_CHECK_CODE,discountId:e.ORDER_DISCOUNT_ID};if(e.JS_STATUS==="BAD")i.color="red";else if(e.JS_STATUS==="APPLYED")i.color="green";else i.color="gray";if(e.DISCOUNT_SIZE)i.discountSize=e.DISCOUNT_SIZE;else i.discountSize="0 %";if(e.APPLY)i.APPLY=e.APPLY;else i.APPLY="N";t.appendChild(this.createCouponRowNode(i))},clearCoupons:function(){var e=this.getCouponsContainerNode();if(!e)return;var t=e.childNodes;while(t.length)e.removeChild(t[0])},createCouponRowNode:function(e){var t="bx-bg-"+e.color,i=this.mode===this.MODES_LIST.EDIT,r=this.mode===this.MODES_LIST.CREATE,a=e.discountSize?e.discountSize:"",s=e.description?BX.util.htmlspecialchars(e.description):"",d=BX.util.htmlspecialchars(e.coupon),o=e.toUse,n=BX.message("SALE_ORDER_BASKET_COUPON")+": "+d+(e.title?"\n"+BX.message("SALE_ORDER_BASKET_COUPON_STATUS")+": "+BX.util.htmlspecialchars(e.title):""),l=e.APPLY,c=e.discountId;return BX.create("li",{props:{className:"bx-adm-pc-sale-item "+t},html:(i?'<input type="hidden" value="N" name="DISCOUNTS[COUPON_LIST]['+d+']">'+'<input type="checkbox" data-discount-id="'+c+'" data-discount="Y" class="bx-adm-pc-input-checkbox" name="DISCOUNTS[COUPON_LIST]['+d+']" value="Y" onclick="BX.Sale.Admin.OrderBasketCoupons.onSetCoupon(\''+d+"', event);\""+(l=="Y"?" checked":"")+' title="'+BX.message("SALE_ORDER_BASKET_COUPON_APPLY")+'">':"")+'<div class="bx-adm-pc-sale-item-block'+(i?"":" bx-amd-l0")+(r?"":" bx-adm-r0")+'" title="'+n+'">'+'<div class="bx-adm-pc-sale-overname"><div class="bx-adm-pc-sale-cost">'+(a.length>0?a:"0")+"</div>"+s+"</div>"+"</div>"+(r?'<div class="bx-adm-pc-sale-item-remover" onclick="BX.Sale.Admin.OrderBasketCoupons.onDeleteCoupon(\''+d+'\');"  title="'+BX.message("SALE_ORDER_BASKET_COUPON_DELETE")+'"></div>':"")})},setCoupons:function(e){this.clearCoupons();if(!e)return;for(var t in e)this.addCouponRow(e[t])}};
//# sourceMappingURL=order_basket.map.js