BX.namespace("BX.Sale.Admin.OrderShipment");BX.Sale.Admin.OrderShipment=function(e){this.index=e.index;this.shipment_statuses=e.shipment_statuses;this.isAjax=!!e.isAjax;this.srcList=e.src_list;this.active=!!e.active;this.discounts=e.discounts||{};this.discountsMode=e.discountsMode||"edit";if(this.active){this.initFieldChangeDeducted();this.initFieldChangeAllowDelivery();this.initFieldChangeStatus()}this.initFieldUpdateSum();this.initChangeProfile();this.initCustomEvent();this.initToggle();this.initDeleteShipment();if(this.discounts)this.setDiscountsList(this.discounts);var i=[];if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){i["BASE_PRICE_DELIVERY"]={callback:this.setDeliveryBasePrice,context:this};i["DELIVERY_PRICE_DISCOUNT"]={callback:this.setDeliveryPrice,context:this}}if(!!e.base_price_delivery)this.setCustomPriceDelivery(e.base_price_delivery);if(e.templateType=="edit"){i["CUSTOM_PRICE"]={callback:this.setCustomPriceDelivery,context:this};i["DELIVERY_ERROR"]={callback:BX.Sale.Admin.OrderEditPage.showDialog,context:this};i["MAP"]={callback:this.updateMap,context:this};i["PROFILES"]={callback:this.updateProfiles,context:this};i["EXTRA_SERVICES"]={callback:this.updateExtraService,context:this};i["DELIVERY_SERVICE_LIST"]={callback:this.updateDeliveryList,context:this};if(!!BX.Sale.Admin.OrderBuyer&&!!BX.Sale.Admin.OrderBuyer.propertyCollection){var t=BX.Sale.Admin.OrderBuyer.propertyCollection.getDeliveryLocation();if(t){t.addEvent("change",function(){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData(),true)})}}}i["DISCOUNTS_LIST"]={callback:this.setDiscountsList,context:this};BX.Sale.Admin.OrderEditPage.registerFieldsUpdaters(i)};BX.Sale.Admin.OrderShipment.prototype.updateDeliveryList=function(e){var i=BX("DELIVERY_"+this.index);if(!i)return;var t=i.options[i.selectedIndex].value;i.innerHTML=e;for(var r in i.options){if(i.options[r].value==t){i.options[r].selected=true;break}}};BX.Sale.Admin.OrderShipment.prototype.setDiscountsList=function(e){this.discounts=e;var i=BX("sale-order-shipment-discounts-container-"+this.index),t=BX("sale-order-shipment-discounts-row-"+this.index),r="none";if(i){i.innerHTML="";if(e&&e.RESULT&&e.RESULT.DELIVERY&&e.RESULT.DELIVERY.length>0){i.appendChild(this.createDiscountsNode(e.RESULT.DELIVERY));r=""}}if(t&&t.nextElementSibling){t.style.display=r;t.nextElementSibling.style.display=r}};BX.Sale.Admin.OrderShipment.prototype.createDiscountsNode=function(e){return BX.Sale.Admin.OrderEditPage.createDiscountsNode("","DELIVERY",e,this.discounts,this.discountsMode=="edit"?"EDIT":"VIEW")};BX.Sale.Admin.OrderShipment.prototype.updateProfiles=function(e){var i=null;var t=BX("BLOCK_DELIVERY_SERVICE_"+this.index);var r=BX("BLOCK_PROFILES_"+this.index);var n=BX("PROFILE_"+this.index);if(n)i=n.options[n.selectedIndex].value;if(r)BX.remove(r);var a=BX.create("tr",{props:{id:"BLOCK_PROFILES_"+this.index},children:[BX.create("td",{text:BX.message("SALE_ORDER_SHIPMENT_PROFILE")+":",style:{width:"40%"},props:{className:"adm-detail-content-cell-l"}}),BX.create("td",{html:e,props:{id:" PROFILE_SELECT_"+this.index,className:"adm-detail-content-cell-r"}})]});t.parentNode.appendChild(a);n=a.lastChild.firstChild;if(i){for(var s in n.options){if(n.options[s].value==i){n.options[s].selected=true;break}}}BX.bind(n,"change",BX.proxy(function(){if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData());this.updateDeliveryLogotip()}else{this.updateDeliveryInfo()}},this))};BX.Sale.Admin.OrderShipment.prototype.updateExtraService=function(e){var i=BX("DELIVERY_INFO_"+this.index);i.innerHTML=e};BX.Sale.Admin.OrderShipment.prototype.updateShipmentStatus=function(e,i,t){var r={action:"updateShipmentStatus",orderId:BX("ID").value,shipmentId:BX("SHIPMENT_ID_"+this.index).value,field:e,status:i,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{this[t.callback](t.args);if(e.RESULT)BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.RESULT)}},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(r)};BX.Sale.Admin.OrderShipment.prototype.updateMap=function(e){var i=BX.processHTML(e);var t=BX("section_map_"+this.index);t.innerHTML=i["HTML"];for(var r in i["SCRIPT"])BX.evalGlobal(i["SCRIPT"][r]["JS"]);BX.loadCSS(i["STYLE"])};BX.Sale.Admin.OrderShipment.prototype.updateDeliveryLogotip=function(){var e=BX("DELIVERY_"+this.index);var i=BX.findParent(e,{tag:"tbody"},true);if(i.children.length>1)e=BX("PROFILE_"+this.index);var t="";var r="";var n=0;if(this.srcList[BX(e).value])n=BX(e).value;t=this.srcList[n]["MAIN"];r=this.srcList[n]["SHORT"];var a=BX("delivery_service_logo_"+this.index);if(!!a)a.style.background="url("+t+")";var s=BX("delivery_service_short_logo_"+this.index);if(!!s)s.style.background="url("+r+")"};BX.Sale.Admin.OrderShipment.prototype.initChangeProfile=function(){var e=BX("DELIVERY_"+this.index);BX.bind(e,"change",BX.proxy(function(){var i=BX("DELIVERY_INFO_"+this.index);i.innerHTML="";var t=BX("section_map_"+this.index);t.innerHTML="";var r=BX("BLOCK_PROFILES_"+this.index);if(r)BX.remove(r);if(BX.Sale.Admin.OrderEditPage.formId=="order_shipment_edit_info_form"){var n=BX("sale-order-shipment-discounts-row-"+this.index);if(n){BX.hide(n.nextElementSibling);BX.hide(n)}var a=BX("CUSTOM_PRICE_DELIVERY_"+this.index);if(a.value!="Y"){BX("BASE_PRICE_DELIVERY_"+this.index).value=parseFloat(BX("PRICE_DELIVERY_"+this.index).innerHTML);a.value="Y"}}var s=BX(e).value;if(s>0)this.updateDeliveryInfo();else this.setDeliveryPrice(0)},this));var i=BX("PROFILE_"+this.index);if(i){BX.bind(i,"change",BX.proxy(function(){var e=BX("DELIVERY_INFO_"+this.index);e.innerHTML="";var t=BX("section_map_"+this.index);t.innerHTML="";if(BX.Sale.Admin.OrderEditPage.formId=="order_shipment_edit_info_form"){var r=BX("sale-order-shipment-discounts-row-"+this.index);if(r){BX.hide(r.nextElementSibling);BX.hide(r)}var n=BX("CUSTOM_PRICE_DELIVERY_"+this.index);if(n.value!="Y"){BX("BASE_PRICE_DELIVERY_"+this.index).value=parseFloat(BX("PRICE_DELIVERY_"+this.index).innerHTML);n.value="Y"}}var a=BX(i).value;if(a>0)this.updateDeliveryInfo();else this.setDeliveryPrice(0)},this))}};BX.Sale.Admin.OrderShipment.prototype.initFieldChangeDeducted=function(){var e=BX("STATUS_DEDUCTED_"+this.index);var i=["SHORT_"+this.index,this.index];for(var t in i){var r=BX("BUTTON_DEDUCTED_"+i[t]);if(!r)continue;var n=[];if(e.value=="N"){n.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_DEDUCTED_YES"),ONCLICK:BX.proxy(function(){var e={status:"Y"};if(this.isAjax)this.updateShipmentStatus("DEDUCTED","Y",{callback:"setDeducted",args:e});else this.setDeducted(e)},this)})}else{n.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_DEDUCTED_NO"),ONCLICK:BX.proxy(function(){var e={status:"N"};if(this.isAjax)this.updateShipmentStatus("DEDUCTED","N",{callback:"setDeducted",args:e});else this.setDeducted(e)},this)})}var a=new BX.COpener({DIV:r.parentNode,MENU:n})}};BX.Sale.Admin.OrderShipment.prototype.setDeducted=function(e){var i=e.status=="Y"?"YES":"NO";var t=BX("STATUS_DEDUCTED_"+this.index);var r=["SHORT_"+this.index,this.index];t.value=e.status;for(var n in r){var a=BX("BUTTON_DEDUCTED_"+r[n]);if(!a)continue;BX.html(a,BX.message("SALE_ORDER_SHIPMENT_DEDUCTED_"+i));if(e.status=="Y")BX.removeClass(a,"notdeducted");else BX.addClass(a,"notdeducted")}this.initFieldChangeDeducted()};BX.Sale.Admin.OrderShipment.prototype.initFieldChangeStatus=function(){var e=["SHORT_"+this.index,this.index];var i=BX("STATUS_SHIPMENT_"+this.index);for(var t in e){var r=BX("BUTTON_SHIPMENT_"+e[t]);var n=[];for(var a in this.shipment_statuses){if(this.shipment_statuses[a].ID==i.value)continue;function s(e,i){var t={name:e.NAME,id:e.ID};var r={TEXT:e.NAME,ONCLICK:function(){i.updateShipmentStatus("STATUS_ID",e.ID,{callback:"setDeliveryStatus",args:t})}};n.push(r)}s(this.shipment_statuses[a],this)}if(r){var d=new BX.COpener({DIV:r.parentNode,MENU:n})}}};BX.Sale.Admin.OrderShipment.prototype.setDeliveryStatus=function(e){var i=BX("STATUS_SHIPMENT_"+this.index);i.value=e.id;var t=["SHORT_"+this.index,this.index];for(var r in t){var n=BX("BUTTON_SHIPMENT_"+t[r]);BX.html(n,e.name)}this.initFieldChangeStatus()};BX.Sale.Admin.OrderShipment.prototype.setDeliveryBasePrice=function(e){if(!BX("BASE_PRICE_DELIVERY_"+this.index))return;BX("BASE_PRICE_DELIVERY_"+this.index).value=e};BX.Sale.Admin.OrderShipment.prototype.setDeliveryPrice=function(e){if(!BX("PRICE_DELIVERY_"+this.index))return;BX("PRICE_DELIVERY_"+this.index).innerHTML=e};BX.Sale.Admin.OrderShipment.prototype.setCustomPriceDelivery=function(e){var i=BX("CUSTOM_PRICE_DELIVERY_"+this.index);if(i.value!="Y")return;var t=BX("PRICE_DELIVERY_"+this.index);var r=BX.findParent(t,{tag:"tbody"},true);var n=BX.findChildByClassName(r,"row_set_new_delivery_price");if(n)BX.remove(n);BX("CUSTOM_PRICE_"+this.index).value=e;var a=BX.create("tr",{children:[BX.create("td",{html:BX.message("SALE_ORDER_SHIPMENT_NEW_PRICE_DELIVERY")+": ",props:{className:"adm-detail-content-cell-l"}}),BX.create("td",{children:[BX.create("span",{text:BX.Sale.Admin.OrderEditPage.currencyFormat(e)}),BX.create("span",{text:BX.message("SALE_ORDER_SHIPMENT_APPLY"),props:{onclick:BX.proxy(function(){if(confirm(BX.message("SALE_ORDER_SHIPMENT_CONFIRM_SET_NEW_PRICE"))){BX("BASE_PRICE_DELIVERY_"+this.index).value=e;var t=BX.findChildByClassName(r,"row_set_new_delivery_price");BX.remove(t);if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){i.value="N";BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}}},this),className:"new_delivery_price_button"}})],props:{className:"adm-detail-content-cell-r"}})],props:{className:"row_set_new_delivery_price"}});r.appendChild(a)};BX.Sale.Admin.OrderShipment.prototype.updateDeliveryInfo=function(){var e=BX.Sale.Admin.OrderEditPage.getAllFormData();var i={action:"changeDeliveryService",formData:e,index:this.index,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.SHIPMENT_DATA);this.updateDeliveryLogotip()}},this)};if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form")BX.Sale.Admin.OrderAjaxer.sendRequest(i,false,true);else BX.Sale.Admin.OrderAjaxer.sendRequest(i,false,false)};BX.Sale.Admin.OrderShipment.prototype.getDeliveryPrice=function(){var e=BX.Sale.Admin.OrderEditPage.getAllFormData();var i={action:"getDefaultDeliveryPrice",formData:e,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0)BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR);else BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.RESULT)},this)};var t=BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form";BX.Sale.Admin.OrderAjaxer.sendRequest(i,false,t)};BX.Sale.Admin.OrderShipment.prototype.initCustomEvent=function(){BX.addCustomEvent("onDeliveryExtraServiceValueChange",BX.proxy(function(e){if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}else{this.getDeliveryPrice()}},this))};BX.Sale.Admin.OrderShipment.prototype.initFieldChangeAllowDelivery=function(){var e=BX("STATUS_ALLOW_DELIVERY_"+this.index);var i=["SHORT_"+this.index,this.index];for(var t in i){var r=BX("BUTTON_ALLOW_DELIVERY_"+i[t]);if(!r)continue;var n=[];if(e.value=="Y"){n.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_ALLOW_DELIVERY_NO"),ONCLICK:BX.proxy(function(){var e={status:"N"};if(this.isAjax)this.updateShipmentStatus("ALLOW_DELIVERY","N",{callback:"setAllowDelivery",args:e});else this.setAllowDelivery(e)},this)})}else{n.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_ALLOW_DELIVERY_YES"),ONCLICK:BX.proxy(function(){var e={status:"Y"};if(this.isAjax)this.updateShipmentStatus("ALLOW_DELIVERY","Y",{callback:"setAllowDelivery",args:e});else this.setAllowDelivery(e);this.initFieldChangeAllowDelivery()},this)})}var a=new BX.COpener({DIV:r.parentNode,MENU:n})}};BX.Sale.Admin.OrderShipment.prototype.setAllowDelivery=function(e){var i=e.status=="Y"?"YES":"NO";var t=["SHORT_"+this.index,this.index];var r=BX("STATUS_ALLOW_DELIVERY_"+this.index);r.value=e.status;for(var n in t){var a=BX("BUTTON_ALLOW_DELIVERY_"+t[n]);if(!a)continue;BX.html(a,BX.message("SALE_ORDER_SHIPMENT_ALLOW_DELIVERY_"+i));if(e.status=="Y")BX.removeClass(a,"notdelivery");else BX.addClass(a,"notdelivery")}this.initFieldChangeAllowDelivery()};BX.Sale.Admin.OrderShipment.prototype.initFieldUpdateSum=function(){var e=BX("BASE_PRICE_DELIVERY_"+this.index);var i=BX("CUSTOM_PRICE_DELIVERY_"+this.index);BX.bind(e,"change",BX.proxy(function(){i.value="Y";if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}else{var e=BX("sale-order-shipment-discounts-row-"+this.index);if(e){BX.hide(e.nextElementSibling);BX.hide(e)}BX("CUSTOM_PRICE_DELIVERY_"+this.index).value="Y"}},this))};BX.Sale.Admin.OrderShipment.prototype.initToggle=function(){var e=BX("SHIPMENT_SECTION_"+this.index);var i=BX("SHIPMENT_SECTION_SHORT_"+this.index);var t=BX("SHIPMENT_SECTION_"+this.index+"_TOGGLE");BX.bind(t,"click",BX.proxy(function(){t.innerHTML=i.style.display!="none"?BX.message("SALE_ORDER_SHIPMENT_BLOCK_SHIPMENT_TOGGLE"):BX.message("SALE_ORDER_SHIPMENT_BLOCK_SHIPMENT_TOGGLE_UP");BX.toggle(e);BX.toggle(i)},this))};BX.Sale.Admin.OrderShipment.prototype.initDeleteShipment=function(){var e=BX("SHIPMENT_SECTION_"+this.index+"_DELETE");BX.bind(e,"click",BX.proxy(function(){if(confirm(BX.message("SALE_ORDER_SHIPMENT_CONFIRM_DELETE_SHIPMENT"))){var e=BX("ID")?BX("ID").value:0;var i=BX("SHIPMENT_ID_"+this.index)?BX("SHIPMENT_ID_"+this.index).value:0;if(e>0&&i>0){var t={action:"deleteShipment",order_id:e,shipment_id:i,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.RESULT);BX.cleanNode(BX("shipment_container_"+this.index))}},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(t)}}},this))};BX.namespace("BX.Sale.Admin.GeneralShipment");BX.Sale.Admin.GeneralShipment={getIds:function(){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())},createNewShipment:function(){var e=BX("ID").value;window.location="/bitrix/admin/sale_order_shipment_edit.php?lang="+BX.Sale.Admin.OrderEditPage.languageId+"&order_id="+e+"&backurl="+encodeURIComponent(window.location.pathname+window.location.search)},findProductByBarcode:function(e){BX.hide(e.parentNode);BX.show(e.parentNode.nextElementSibling)}};
//# sourceMappingURL=order_shipment.map.js