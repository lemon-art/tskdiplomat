(function(){var t=window.BX,e=window.BXMobileApp;if(t&&t["Mobile"]&&t["Mobile"]["Grid"]&&t["Mobile"]["Grid"]["Form"])return;t.namespace("BX.Mobile.Grid.Form");var i={formId:{},gridId:{}},s=function(){var i=function(e,i,s){this.click=t.delegate(this.click,this);this.callback=t.delegate(this.callback,this);this.init(e,i,s)};i.prototype={multiple:false,select:null,eventNode:null,container:null,init:function(e,i,s){if(t(e)&&e.options.length>0&&t(i)&&t(s)){e.setAttribute("bx-bound","Y");this.select=e;this.eventNode=i;this.container=s;t.bind(this.eventNode,"click",this.click);this.multiple=e.hasAttribute("multiple");this.initValues()}},initValues:function(){this.titles=[];this.values=[];this.defaultTitles=[];for(var t=0;t<this.select.options.length;t++){this.titles.push(this.select.options[t].innerHTML);this.values.push(this.select.options[t].value);if(this.select.options[t].hasAttribute("selected"))this.defaultTitles.push(this.select.options[t].innerHTML)}},click:function(e){this.show();return t.PreventDefault(e)},show:function(){e.UI.SelectPicker.show({callback:this.callback,values:this.titles,multiselect:this.multiple,default_value:this.defaultTitles})},callback:function(e){this.defaultTitles=[];if(e&&e.values&&e.values.length>0){var i=[],s,n;for(s=0;s<this.titles.length;s++){for(n=0;n<e.values.length;n++){if(this.titles[s]==e.values[n]){i.push(this.values[s]);this.defaultTitles.push(this.titles[s]);break}}}var o="";for(s=0;s<this.select.options.length;s++){this.select.options[s].removeAttribute("selected");if(t.util.in_array(this.select.options[s].value,i)){this.select.options[s].setAttribute("selected","selected");if(this.multiple){o+='<a href="javascript:void();">'+this.select.options[s].innerHTML+"</a>"}else{o=this.select.options[s].innerHTML}}}if(o===""&&!this.multiple)o='<span style="color:grey">'+t.message("interface_form_select")+"</span>";this.container.innerHTML=o;t.onCustomEvent(this,"onChange",[this,this.select])}}};return i}(),n=function(){var i=function(e,i,s,n){this.type=i;this.node=e;this.container=s;this.click=t.delegate(this.click,this);this.callback=t.delegate(this.callback,this);t.bind(this.container,"click",this.click);this.init(n)};i.prototype={type:"datetime",format:{inner:{datetime:"dd.MM.yyyy H:mm",time:"H:mm",date:"dd.MM.yyyy"},bitrix:{datetime:null,time:null,date:null},visible:{datetime:null,time:null,date:null}},node:null,click:function(e){t.eventCancelBubble(e);this.show();return t.PreventDefault(e)},show:function(){var t={type:this.type,start_date:this.getStrDate(this.node.value),format:this.format.inner[this.type],callback:this.callback};if(t["start_date"]=="")delete t["start_date"];e.UI.DatePicker.setParams(t);e.UI.DatePicker.show()},callback:function(e){this.node.value=e;this.container.innerHTML=e;this.delButton.style.display="inline-block";t.onCustomEvent(this,"onChange",[this,this.node])},makeDate:function(e){var i=new Date;if(t.type.isNotEmptyString(e)){var s=new RegExp("(\\d{2}).(\\d{2}).(\\d{4})"),n=new RegExp("(\\d{2}):(\\d{2})"),o;if(s.test(e)&&(o=s.exec(e))&&o){i.setDate(o[1]);i.setMonth(o[2]-1);i.setFullYear(o[3])}if(n.test(e)&&(o=n.exec(e))&&o){i.setHours(o[1]);i.setMinutes(o[2])}}return i},getStrDate:function(e){var i=t.parseDate(e),s="";if(i!==null){if(this.type=="date"||this.type=="datetime"){s=t.util.str_pad_left(i.getDate().toString(),2,"0")+"."+t.util.str_pad_left(i.getMonth().toString(),2,"0")+"."+i.getFullYear().toString()}if(this.type=="datetime")s+=" ";if(this.type=="time"||this.type=="datetime"){s+=t.util.str_pad_left(i.getHours().toString(),2,"0")+":"+i.getMinutes().toString()}}return s},init:function(e){var i=t.date.convertBitrixFormat(t.message("FORMAT_DATETIME")),s=t.date.convertBitrixFormat(t.message("FORMAT_DATE")),n;if(i.substr(0,s.length)==s)n=t.util.trim(i.substr(s.length));else n=t.date.convertBitrixFormat(i.indexOf("T")>=0?"H:MI:SS T":"HH:MI:SS");this.format.bitrix.datetime=i;this.format.bitrix.date=s;this.format.bitrix.time=n;e=e||{};this.format.visible.datetime=e["datetime"]||i.replace(":s","");this.format.visible.date=e["date"]||s;this.format.visible.time=e["time"]||n.replace(":s","");this.format.visible.datetime=[["today","today, "+this.format.visible.time],["tommorow","tommorow, "+this.format.visible.time],["yesterday","yesterday, "+this.format.visible.time],["",this.format.visible.datetime]];this.format.visible.date=[["today","today"],["tommorow","tommorow"],["yesterday","yesterday"],["",this.format.visible.date]];this.delButton=t(this.node.id+"_del");t.bind(this.delButton,"click",t.proxy(function(){this.drop()},this))},drop:function(){this.node.value="";this.container.innerHTML=this.container.getAttribute("placeholder");this.delButton.style.display="none"}};return i}(),o=function(){var i=function(e,i,s){this.click=t.delegate(this.click,this);this.callback=t.delegate(this.callback,this);this.drop=t.delegate(this.drop,this);this.select=t(e);this.eventNode=t(i);this.container=t(s);t.bind(this.eventNode,"click",this.click);this.multiple=e.hasAttribute("multiple");this.showDrop=!(e.hasAttribute("bx-can-drop")&&e.getAttribute("bx-can-drop").toString()=="false");this.urls={list:t.message("SITE_DIR")+"mobile/index.php?mobile_action=get_user_list",profile:t.message("interface_form_user_url")};this.actualizeNodes()};i.prototype={multiple:false,select:null,eventNode:null,container:null,showDrop:true,showMenu:false,click:function(e){this.show();return t.PreventDefault(e)},show:function(){new e.UI.Table({url:this.urls.list,table_settings:{callback:this.callback,markmode:true,multiple:this.multiple,return_full_mode:true,skipSpecialChars:true,modal:true,alphabet_index:true,outsection:false,okname:t.message("interface_form_select"),cancelname:t.message("interface_form_cancel")}},"users").show()},drop:function(){var e=t.proxy_context,i=e.id.replace(this.select.id+"_del_","");for(var s=0;s<this.select.options.length;s++){if(this.select.options[s].value+""==i+""){t.remove(t.findParent(e,{tagName:"DIV",className:"mobile-grid-field-select-user-item"}));t.remove(this.select.options[s])}}t.onCustomEvent(this,"onChange",[this,this.select])},actualizeNodes:function(){for(var e=0;e<this.select.options.length;e++){if(t(this.select.id+"_del_"+this.select.options[e].value)){t.bind(t(this.select.id+"_del_"+this.select.options[e].value),"click",this.drop)}}},buildNodes:function(e){var i="",s="",n,o,l=[];for(n=0;n<this.select.options.length;n++){l.push(this.select.options[n].value.toString())}for(n=0;n<Math.min(this.multiple?e.length:1,e.length);n++){o=e[n];if(t.util.in_array(o["ID"],l))continue;i+='<option value="'+o["ID"]+'" selected>"'+t.util.htmlspecialchars(o["NAME"])+'"</option>';s+=['<div class="mobile-grid-field-select-user-item-outer">','<div class="mobile-grid-field-select-user-item">',this.showDrop?'<del id="'+this.select.id+"_del_"+o["ID"]+'"></del>':"",'<div class="avatar"',o["IMAGE"]?" style=\"background-image:url('"+o["IMAGE"]+"')\"":"","></div>","<span onclick=\"BXMobileApp.PageManager.loadPageBlank({url: '"+this.urls.profile.replace("#ID#",o["ID"])+"',bx24ModernStyle : true});\">"+t.util.htmlspecialchars(o["NAME"])+"</span>","</div>","</div>"].join("").replace(" style=\"background-image:url('')\"","")}if(s!=""){this.select.innerHTML=(this.multiple?this.select.innerHTML:"")+i;this.container.innerHTML=(this.multiple?this.container.innerHTML:"")+s;t.onCustomEvent(this,"onChange",[this,this.select]);var a=0,r=t.proxy(function(){if(a<100){if(this.container.childNodes.length>0)this.actualizeNodes();else if(a++)setTimeout(r,50)}},this);setTimeout(r,50)}},callback:function(t){if(t&&t.a_users)this.buildNodes(t.a_users)}};return i}(),l=function(){var e=function(e,i,s){l.superclass.constructor.apply(this,arguments);this.urls={list:t.message("SITE_DIR")+"mobile/index.php?mobile_action=get_group_list",profile:t.message("interface_form_group_url")}};t.extend(e,o);e.prototype.callback=function(t){if(t&&t.b_groups)this.buildNodes(t.b_groups)};return e}(),a=function(){var e=function(e,i){this.node=e;this.container=i;this.click=t.delegate(this.click,this);this.callback=t.delegate(this.callback,this);t.bind(this.container,"click",this.click)};e.prototype={click:function(e){this.show();return t.PreventDefault(e)},show:function(){window.app.exec("showPostForm",{attachButton:{items:[]},attachFileSettings:{},attachedFiles:[],extraData:{},mentionButton:{},smileButton:{},message:{text:t.util.htmlspecialcharsback(this.node.value)},okButton:{callback:this.callback,name:t.message("interface_form_save")},cancelButton:{callback:function(){},name:t.message("interface_form_cancel")}})},callback:function(e){e.text=t.util.htmlspecialchars(e.text)||"";this.node.value=e.text;if(e.text=="")this.container.innerHTML='<span class="placeholder">'+this.node.getAttribute("placeholder")+"</span>";else this.container.innerHTML=e.text;t.onCustomEvent(this,"onChange",[this,this.node])}};return e}(),r=function(){var e=function(e){this.node=e;t.bind(this.node,"change",t.delegate(this.change,this))};e.prototype={change:function(){t.onCustomEvent(this,"onChange",[this,this.node])}};return e}();window.app.exec("enableCaptureKeyboard",true);t.Mobile.Grid.Form=function(s){e.UI.Page.LoadingScreen.hide();if(typeof s==="object"){this.gridId=s["gridId"]||"";this.formId=s["formId"]||"";if(this.gridId!="")i["gridId"][this.gridId]=this;if(this.formId!="")i["formId"][this.formId]=this;this.formats=s["formats"]||null;var n=s["customElements"]||[],o,l;this.apply=t.delegate(this.apply,this);this.restrictedMode=s["restrictedMode"];while((o=n.pop())&&o){if((l=this.bindElement(t(o)))&&l){this.elements.push(l);if(s["restrictedMode"])t.addCustomEvent(l,"onChange",this.apply)}}if(t(this.formId)&&t("submit_"+this.formId)){t.bind(t("submit_"+this.formId),"click",t.delegate(this.click,this));t.bind(t("cancel_"+this.formId),"click",t.delegate(this.cancel,this))}else if(s["buttons"]=="app"){window.BXMobileApp.UI.Page.TopBar.updateButtons({cancel:{type:"back_text",callback:t.delegate(this.cancel,this),name:t.message("interface_form_cancel"),bar_type:"navbar",position:"left"},ok:{type:"back_text",callback:t.delegate(this.click,this),name:t.message("interface_form_save"),bar_type:"navbar",position:"right"}})}if(t("buttons_"+this.formId)){var a=this.formId;t.addCustomEvent("onKeyboardWillShow",function(){t.addClass(t("buttons_"+a),"mobile-grid-button-panel-regular")});t.addCustomEvent("onKeyboardDidHide",function(){t.removeClass(t("buttons_"+a),"mobile-grid-button-panel-regular")})}}};t.Mobile.Grid.Form.prototype={elements:[],bindElement:function(e){var i=null;if(t(e)){var c=e.tagName.toLowerCase(),h=e.hasAttribute("bx-type")?e.getAttribute("bx-type").toLowerCase():"";if(c=="select"&&e.getAttribute("bx-type")=="select-user"){i=new o(e,t(e.id+"_select"),t(e.id+"_target"))}else if(c=="select"&&e.getAttribute("bx-type")=="select-group"){i=new l(e,t(e.id+"_select"),t(e.id+"_target"))}else if(c=="select"){i=new s(e,t(e.id+"_select"),e.hasAttribute("multiple")?t(e.id+"_target"):t(e.id+"_select"))}else if(e.getAttribute("type")=="text"){t.bind(e,"keyup",function(i){i=i||window.event;if(i&&i.keyCode==13){var s,n=false;t.eventCancelBubble(i);for(s=0;s<e.form.elements.length;s++){if(n){if(e.form.elements[s].tagName.toLowerCase()=="textarea"||e.form.elements[s].tagName.toLowerCase()=="input"&&e.form.elements[s].getAttribute("type").toLowerCase()=="text"){t.focus(e.form.elements[s])}break}n=e.form.elements[s]==e}}})}else if(c=="textarea"){}else if(e.getAttribute("type")=="checkbox"||e.getAttribute("type")=="radio"){i=new r(e)}else if(h=="text"||h=="textarea"){i=new a(e,t(e.id+"_target"))}else if(h=="date"||h=="datetime"||h=="time"){i=new n(e,h,t(e.id+"_container"),this.format)}else if(h=="section"){t.bind(e,"click",function(i){t.PreventDefault(i);if(t.hasClass(e,"mobile-grid-field-expanded-head")){t.removeClass(e,"mobile-grid-field-expanded-head");t.removeClass(e.nextSibling,"mobile-grid-field-expanded-body");t.addClass(e,"mobile-grid-field-collapsed-head");t.addClass(e.nextSibling,"mobile-grid-field-collapsed-body")}else{t.removeClass(e,"mobile-grid-field-collapsed-head");t.removeClass(e.nextSibling,"mobile-grid-field-collapsed-body");t.addClass(e,"mobile-grid-field-expanded-head");t.addClass(e.nextSibling,"mobile-grid-field-expanded-body")}return false})}else if(h=="disk_file"){i=t.Disk.UFMobile.getByName(e.value)}}return i},cancel:function(e){if(e)t.PreventDefault(e);t.onCustomEvent(this,"onCancel",[this,t(this.formId)]);return false},click:function(e){if(e)t.PreventDefault(e);this.save();return false},apply:function(e,i){var s={submit:true};t.onCustomEvent(this,"onSubmitForm",[this,t(this.formId),i,s]);window.app.onCustomEvent("onSubmitForm",[this.gridId,this.formId,i?i.id:null]);if(s.submit!==false)this.submit(true)},save:function(){var e={submit:true};t.onCustomEvent(this,"onSubmitForm",[this,t(this.formId),null,e]);window.app.onCustomEvent("onSubmitForm",[this.gridId,this.formId,null]);if(e.submit!==false)this.submit(false)},submit:function(i){if(!t(this.formId))return;var s={restricted:"Y",method:t(this.formId).getAttribute("method"),onsuccess:t.proxy(function(){t.onCustomEvent(this,"onSubmitAjaxSuccess",[this,arguments[0]])},this),onfailure:t.proxy(function(){t.onCustomEvent(this,"onSubmitAjaxFailure",[this,arguments[0]])},this),onprogress:t.proxy(function(){t.onCustomEvent(this,"onSubmitAjaxProgress",[this,arguments])},this)};if(i){t.onCustomEvent(this,"onBeforeSubmitAjax",[this,s])}else{s["restricted"]="N";s["onsuccess"]=t.proxy(function(){e.UI.Page.LoadingScreen.hide();t.onCustomEvent(this,"onSubmitFormSuccess",[this,arguments[0]])},this);s["onfailure"]=t.proxy(function(){e.UI.Page.LoadingScreen.hide();t.onCustomEvent(this,"onSubmitFormFailure",[this,arguments[0]])},this);s["onprogress"]=t.proxy(function(){t.onCustomEvent(this,"onSubmitFormProgress",[this,arguments])},this);t.onCustomEvent(this,"onBeforeSubmitForm",[this,s]);e.UI.Page.LoadingScreen.show()}var n=t(this.formId).elements["save"];if(!t(n)){n=t.create("INPUT",{attrs:{type:"hidden",name:"save"}});t(this.formId).appendChild(n)}n.value="Y";t.ajax.submitAjax(t(this.formId),s)}};t.Mobile.Grid.Form.getByFormId=function(t){return i["formId"][t]};t.Mobile.Grid.Form.getByGridId=function(t){return i["gridId"][t]}})();
//# sourceMappingURL=script.map.js